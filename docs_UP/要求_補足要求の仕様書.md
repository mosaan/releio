# 補足要求の仕様書（Supplementary Specification）

> 特定のユースケースに特有ではない、一般的な要求（機能外要求など）を記述する文書。

本文書は、Electron AI Starter Templateプロジェクトにおける補足的な要求を記述したものです。これらは、特定のユースケースに固有ではなく、システム全体に適用される品質属性、制約、技術要求などを含みます。

---

## 1. 機能要求（Functional Requirements）

### 1.1 データ永続化
- **FR-01**: システムは、全ての会話セッションとメッセージをローカルSQLiteデータベースに永続化しなければならない
- **FR-02**: システムは、アプリケーション設定（AI設定、MCP設定、ネットワーク設定）をデータベースに保存しなければならない
- **FR-03**: 開発環境では `./tmp/db/app.db`、本番環境ではユーザーデータディレクトリ `/db/app.db` にデータベースを配置しなければならない

### 1.2 ログ記録
- **FR-04**: システムは、Main、Backend、Rendererプロセスの全てのログを統一されたログファイルに記録しなければならない
- **FR-05**: 開発環境では `./tmp/logs/app.log`、本番環境ではユーザーデータディレクトリ `/logs/app.log` にログを保存しなければならない
- **FR-06**: ログファイルは5MBを超えた場合にローテーションしなければならない

### 1.3 プロセス間通信（IPC）
- **FR-07**: システムは、Rendererプロセスからのリクエストを安全にBackendプロセスに転送するためにIPCを使用しなければならない
- **FR-08**: IPCは、型安全性を保証するためにTypeScriptの型定義を使用しなければならない

### 1.4 高度なデータ永続化 ⭐
- **FR-09**: システムは、メッセージを原子的なパート（text、tool_invocation、tool_result、attachment、metadata）として保存しなければならない
- **FR-10**: システムは、ツール呼び出しのライフサイクル（開始時刻、完了時刻、レイテンシ、ステータス）を専用テーブルで管理しなければならない
- **FR-11**: システムは、会話履歴の圧縮用スナップショット（要約、カットオフポイント、トークン数）をセッションごとに保存しなければならない
- **FR-12**: システムは、AIモデルのメタデータ（トークン制限、圧縮閾値）をデータベースで管理しなければならない

### 1.5 AI設定管理 ⭐
- **FR-13**: システムは、同じプロバイダータイプでも複数のAI設定を作成・管理できなければならない
- **FR-14**: システムは、プロバイダーAPIからモデルリストを取得して自動更新する機能を提供しなければならない
- **FR-15**: システムは、ユーザーがカスタムモデルIDを手動で追加できる機能を提供しなければならない
- **FR-16**: システムは、API取得モデル（source='api'）とカスタムモデル（source='custom'）を区別して管理しなければならない

### 1.6 MCPサーバー管理 ⭐
- **FR-17**: システムは、MCPサーバーの標準エラー出力（stderr）をキャプチャし、最新10行を保持しなければならない
- **FR-18**: システムは、MCPサーバープロセスの終了コードとシグナルを記録しなければならない

---

## 2. ユーザビリティ要求（Usability Requirements）

### 2.1 レスポンス時間
- **US-01**: チャット画面でのメッセージ送信は、1秒以内にAIプロバイダーへの送信を開始しなければならない
- **US-02**: ストリーミングレスポンスは、最初のトークンを受信後100ms以内に画面に表示を開始しなければならない
- **US-03**: 設定画面での設定変更は、保存ボタンクリック後500ms以内に完了しなければならない

### 2.2 フィードバック
- **US-04**: 長時間かかる操作（ファイルダウンロード、ツール実行など）には、進行状況インジケーターを表示しなければならない
- **US-05**: エラーが発生した場合、ユーザーに理解可能なエラーメッセージを表示しなければならない
- **US-06**: ツール呼び出しの詳細（引数、結果、ステータス）は、展開可能な形式で表示しなければならない

### 2.3 アクセシビリティ
- **US-07**: UIコンポーネントは、WCAG 2.1 レベルAAの基準に準拠しなければならない
- **US-08**: キーボードナビゲーションをサポートしなければならない
- **US-09**: ダークモードとライトモードの両方をサポートしなければならない

---

## 3. 信頼性要求（Reliability Requirements）

### 3.1 エラー処理
- **RE-01**: AIプロバイダーへの接続に失敗した場合、システムはエラーメッセージを表示し、ユーザーが再試行できるようにしなければならない
- **RE-02**: MCPサーバープロセスがクラッシュした場合、システムはエラーログを記録し、ステータスを「エラー」に更新しなければならない
- **RE-03**: データベース操作に失敗した場合、システムはトランザクションをロールバックし、エラーをログに記録しなければならない

### 3.2 データ整合性
- **RE-04**: 会話セッションが削除される際、関連する全てのメッセージも自動的に削除されなければならない（カスケード削除）
- **RE-05**: アプリケーションが予期せず終了した場合でも、データベースの整合性は保たれなければならない

### 3.3 フォールトトレランス
- **RE-06**: ネットワークエラーが発生した場合、システムはユーザーにエラーを通知し、オフラインモードで動作可能な機能（過去の会話閲覧など）を提供しなければならない
- **RE-07**: 更新サーバーへの接続に失敗した場合、システムはサイレントに失敗し、アプリケーションの動作を妨げてはならない

---

## 4. パフォーマンス要求（Performance Requirements）

### 4.1 応答時間
- **PE-01**: データベースからの会話セッション読み込みは、1000メッセージまで500ms以内に完了しなければならない
- **PE-02**: ユースケースモデルで定義された全てのユースケースの応答時間は、上記のユーザビリティ要求に準拠しなければならない

### 4.2 スループット
- **PE-03**: システムは、1秒あたり少なくとも100トークンのストリーミングレスポンスを処理できなければならない
- **PE-04**: 複数のMCPサーバー（最大10個）が同時に実行されている場合でも、システムのレスポンス時間は20%以上劣化してはならない

### 4.3 リソース使用量
- **PE-05**: アイドル状態（会話がない状態）でのメモリ使用量は、200MB以下でなければならない
- **PE-06**: 会話中のCPU使用率は、平均30%以下でなければならない（ストリーミング中は除く）

---

## 5. サポート性要求（Supportability Requirements）

### 5.1 ログ記録
- **SU-01**: 全てのエラーは、タイムスタンプ、エラーメッセージ、スタックトレースとともにログに記録されなければならない
- **SU-02**: ログレベル（debug、info、warn、error）は、設定で変更可能でなければならない
- **SU-03**: ログファイルは、開発者が診断できる形式（構造化ログ）で記録されなければならない

### 5.2 診断機能
- **SU-04**: MCP サーバーの標準エラー出力（stderr）は、リアルタイムでUIに表示されなければならない
- **SU-05**: 接続テスト機能は、詳細なエラー診断情報（認証エラー、ネットワークエラー、証明書エラーなど）を提供しなければならない

---

## 6. セキュリティ要求（Security Requirements）

### 6.1 認証情報の保護
- **SE-01**: APIキーは、データベースに暗号化されて保存されなければならない（現在は平文で保存、将来の改善項目）
- **SE-02**: プロキシ認証情報（パスワード）は、メモリ内でのみ保持され、ディスクに保存されてはならない（または暗号化されなければならない）

### 6.2 ネットワークセキュリティ
- **SE-03**: HTTPS通信では、証明書検証がデフォルトで有効でなければならない
- **SE-04**: 証明書検証を無効化するオプションは、開発環境やテスト環境でのみ使用されることを前提とし、本番環境では非推奨であることを警告しなければならない

### 6.3 プロセス分離
- **SE-05**: Rendererプロセスは、Node.jsの直接的なアクセスを持たず、preloadスクリプトを介してのみ機能にアクセスできなければならない
- **SE-06**: Backendプロセスは、Mainプロセスを介してのみRendererプロセスと通信できなければならない

---

## 7. 実装制約（Implementation Constraints）

### 7.1 技術スタック
- **IC-01**: システムは、Electron 37以降を使用して実装されなければならない
- **IC-02**: フロントエンドは、React 19とTypeScriptを使用して実装されなければならない
- **IC-03**: データベースは、SQLite（libsql）とDrizzle ORMを使用して実装されなければならない
- **IC-04**: AIプロバイダーとの統合は、Vercel AI SDK v5を使用して実装されなければならない

### 7.2 コード品質
- **IC-05**: 全てのTypeScriptコードは、ESLintルールに準拠しなければならない
- **IC-06**: 全てのコードは、Prettierによってフォーマットされなければならない
- **IC-07**: 新しい機能は、可能な限りユニットテスト（Vitest）でカバーされなければならない

### 7.3 ビルドとパッケージング
- **IC-08**: アプリケーションは、electron-builderを使用してパッケージ化されなければならない
- **IC-09**: 本番環境と開発環境の判定は、`app.isPackaged`（Mainプロセス）または `process.resourcesPath !== undefined`（Backendプロセス）を使用しなければならない

---

## 8. インターフェイス要求（Interface Requirements）

### 8.1 ユーザーインターフェイス
- **IN-01**: UIは、Shadcn/ui（New Yorkスタイル）コンポーネントライブラリを使用して実装されなければならない
- **IN-02**: チャットインターフェイスは、Assistant UIライブラリを使用して実装されなければならない
- **IN-03**: アイコンは、Lucide Reactライブラリから選択されなければならない

### 8.2 外部システムインターフェイス
- **IN-04**: AIプロバイダーとの通信は、各プロバイダーの公式APIエンドポイントを使用しなければならない
  - OpenAI: `https://api.openai.com/v1`
  - Anthropic: `https://api.anthropic.com/v1`
  - Google: `https://generativelanguage.googleapis.com/v1`
- **IN-05**: MCPサーバーとの通信は、Model Context Protocol標準仕様に準拠しなければならない
- **IN-06**: 更新サーバーとの通信は、electron-updaterの静的サーバー仕様に準拠しなければならない

---

## 9. プラットフォーム要求（Platform Requirements）

### 9.1 サポートするプラットフォーム
- **PL-01**: システムは、以下のプラットフォームで動作しなければならない：
  - Windows 10以降（完全サポート）
  - macOS 10.15以降（基本サポート、プロキシ自動検出は未サポート）
  - Ubuntu 20.04以降（基本サポート、プロキシ自動検出は未サポート）

### 9.2 プラットフォーム固有の制約
- **PL-02**: Windowsでは、システムプロキシ設定をレジストリから読み取らなければならない
- **PL-03**: Windowsでは、システム証明書ストアから証明書を読み込まなければならない
- **PL-04**: macOSおよびLinuxでは、プロキシモード「System」を選択した場合、警告を表示しなければならない

---

## 10. ライセンスとオープンソース要求（Licensing Requirements）

### 10.1 ライセンス
- **LI-01**: 本プロジェクトは、MITライセンスの下で配布されなければならない
- **LI-02**: 使用する全てのオープンソースライブラリのライセンスは、MITライセンスと互換性がなければならない

### 10.3 著作権
- **LI-03**: 全てのソースコードファイルには、適切な著作権表示が含まれなければならない

---

## 11. 法的、規制、標準要求（Legal and Standards Requirements）

### 11.1 データプライバシー
- **LS-01**: システムは、ユーザーの会話データをローカルにのみ保存し、開発者や第三者に送信してはならない（AIプロバイダーへの送信を除く）
- **LS-02**: ユーザーは、自分の会話データを削除できなければならない

### 11.2 標準準拠
- **LS-03**: HTTPSリクエストは、TLS 1.2以降を使用しなければならない
- **LS-04**: JSON形式のデータは、RFC 8259に準拠しなければならない

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-25 | 1.0 | 初版作成（反復1、方向づけフェーズ） |
| 2025-11-25 | 1.1 | 実装レビューに基づく更新：10個の新しい機能要求を追加（高度なデータ永続化、AI設定管理、MCPサーバー管理）（反復1、方向づけフェーズ） |
