# ネットワーク設定要件

## ドキュメント情報

- **作成日**: 2025-11-18
- **バージョン**: 1.0
- **対象ユースケース**: UC-NET-01 〜 UC-NET-03
- **関連設計**: [プロキシ・証明書設計](./PROXY_AND_CERTIFICATE_DESIGN.md), [プロキシ設定](./PROXY_CONFIGURATION.md)

## 1. UC-NET-01: プロキシ設定を行う

### 1.1 ユースケース概要

ユーザーが企業ネットワーク環境でAIプロバイダーに接続するためのプロキシサーバー設定を行います。

### 1.2 事前条件

- The システム shall 設定画面が表示されている

### 1.3 事後条件

- The システム shall プロキシ設定がデータベースに保存されている
- The システム shall 全てのAI API リクエストが設定されたプロキシを経由する

### 1.4 要件

#### 1.4.1 プロキシモードの選択

**1. プロキシモード選択の提供**

The システム shall 以下のプロキシモードを選択できるようにする：
- System（システム設定を自動検出）
- Custom（手動設定）
- None（プロキシを使用しない、直接接続）

**2. デフォルトモードの設定**

The システム shall 初回起動時にプロキシモードをデフォルトで"System"に設定する

**3. モード別UIの表示**

When ユーザーがプロキシモードを選択した, the システム shall 選択されたモードに応じた設定フィールドを表示する

#### 1.4.2 システムモード（System）

**4. Windows レジストリからの自動検出**

When Windows環境でSystemモードが選択された, the システム shall Windowsレジストリからプロキシ設定を自動検出する

**5. 検出されたプロキシの表示**

When Systemモードでプロキシが検出された, the システム shall 検出されたプロキシURL（ホスト:ポート）を設定画面に表示する

**6. macOS/Linux環境での対応**

When macOS/Linux環境でSystemモードが選択された, the システム shall 現在サポートされていないことを通知し、CustomまたはNoneモードの使用を推奨する

**7. PAC ファイルの非サポート通知**

If システムがPAC（Proxy Auto-Config）ファイルを検出した, the システム shall PACファイルはサポートされていないことを通知し、手動設定の回避策を案内する

#### 1.4.3 カスタムモード（Custom）

**8. プロキシURL入力フィールド**

When Customモードが選択された, the システム shall プロキシURL（ホスト:ポート形式）の入力フィールドを提供する

**9. プロキシプロトコル選択**

When Customモードが選択された, the システム shall プロキシプロトコル（HTTP、HTTPS）の選択オプションを提供する

**10. プロキシ認証の提供**

When Customモードが選択された, the システム shall プロキシ認証（ユーザー名、パスワード）のオプションフィールドを提供する

**11. プロキシURL形式の検証**

If ユーザーが無効な形式のプロキシURLを入力した, the システム shall エラーメッセージを表示し、正しい形式（例: proxy.company.com:8080）を要求する

#### 1.4.4 Noneモード（直接接続）

**12. Noneモードの提供**

The システム shall プロキシを使用せず直接接続するNoneモードを提供する

**13. Noneモード選択時の警告**

When ユーザーがNoneモードを選択した, the システム shall 企業ネットワーク環境で接続が失敗する可能性があることを警告する

#### 1.4.5 プロキシ設定の保存

**14. 設定の永続化**

When ユーザーがプロキシ設定を保存した, the システム shall 設定をデータベースのAI設定（ai_v2キー）に保存する

**15. 設定の即座適用**

When ユーザーがプロキシ設定を保存した, the システム shall 次回のAI APIリクエストから新しいプロキシ設定を適用する

**16. プロキシ認証情報の保護**

When ユーザーがプロキシ認証情報を入力した, the システム shall 認証情報をデータベースに平文で保存し、userDataディレクトリのパーミッションで保護する

---

## 2. UC-NET-02: 証明書を設定する

### 2.1 ユースケース概要

ユーザーがカスタムCA証明書や証明書検証設定を行います。

### 2.2 事前条件

- The システム shall 設定画面が表示されている

### 2.3 事後条件

- The システム shall 証明書設定がデータベースに保存されている
- The システム shall 全てのHTTPSリクエストが設定された証明書設定を使用する

### 2.4 要件

#### 2.4.1 証明書モードの選択

**17. 証明書モード選択の提供**

The システム shall 以下の証明書モードを選択できるようにする：
- System（OSのシステム証明書ストアを使用）
- Custom（カスタムCA証明書を指定）
- None（証明書検証を無効化）

**18. デフォルトモードの設定**

The システム shall 初回起動時に証明書モードをデフォルトで"System"に設定する

**19. モード別UIの表示**

When ユーザーが証明書モードを選択した, the システム shall 選択されたモードに応じた設定フィールドを表示する

#### 2.4.2 システムモード（System）

**20. Windows証明書ストアの使用**

When Windows環境でSystemモードが選択された, the システム shall Windowsのシステム証明書ストアから証明書を読み込む

**21. システム証明書の表示**

When Systemモードが選択された, the システム shall 使用されるシステム証明書ストアのパスを設定画面に表示する

**22. macOS/Linux環境での対応**

When macOS/Linux環境でSystemモードが選択された, the システム shall 現在システム証明書の自動読み込みはサポートされていないことを通知し、Customモードの使用を推奨する

#### 2.4.3 カスタムモード（Custom）

**23. CA証明書ファイル選択**

When Customモードが選択された, the システム shall CA証明書ファイル（.pem、.crt、.cer形式）を選択するファイルピッカーを提供する

**24. 証明書内容の検証**

When ユーザーがCA証明書ファイルを選択した, the システム shall 証明書が有効なX.509形式であることを検証する

**25. 証明書情報の表示**

When 有効なCA証明書が読み込まれた, the システム shall 証明書の発行者（Issuer）、サブジェクト（Subject）、有効期限を表示する

**26. 証明書の永続化**

When ユーザーがカスタムCA証明書を保存した, the システム shall 証明書内容（PEM形式テキスト）をデータベースに保存する

#### 2.4.4 Noneモード（検証無効化）

**27. Noneモードの提供**

The システム shall 証明書検証を無効化するNoneモードを提供する

**28. Noneモード選択時の警告**

When ユーザーがNoneモードを選択した, the システム shall セキュリティリスク（中間者攻撃の可能性）があることを警告する

**29. Noneモードの推奨されない用途**

The システム shall Noneモードは開発環境・テスト環境のみで使用し、本番環境では使用しないよう注意書きを表示する

#### 2.4.5 証明書設定の保存

**30. 設定の永続化**

When ユーザーが証明書設定を保存した, the システム shall 設定をデータベースのAI設定（ai_v2キー）に保存する

**31. 設定の即座適用**

When ユーザーが証明書設定を保存した, the システム shall 次回のHTTPSリクエストから新しい証明書設定を適用する

---

## 3. UC-NET-03: 接続テストを実行する

### 3.1 ユースケース概要

ユーザーが設定したネットワーク構成（プロキシ・証明書）でAIプロバイダーへの接続をテストします。

### 3.2 事前条件

- The システム shall 少なくとも1つのプロバイダー設定が存在し、有効なAPIキーが設定されている

### 3.3 事後条件

- The システム shall 接続テスト結果（成功/失敗）が表示されている

### 3.4 要件

#### 3.4.1 接続テストの開始

**32. 接続テストボタンの提供**

The システム shall プロキシ・証明書設定画面に「接続テスト」ボタンを提供する

**33. テスト対象プロバイダーの選択**

The システム shall 接続テストを実行するプロバイダー設定を選択できるドロップダウンを提供する

**34. テスト中の視覚的フィードバック**

While システムが接続テストを実行している, the システム shall ローディングインジケーターを表示し、ボタンを無効化する

#### 3.4.2 接続テストの実行

**35. APIエンドポイントへのリクエスト送信**

When ユーザーが接続テストを実行した, the システム shall 選択されたプロバイダーのAPIエンドポイントに簡単なリクエスト（モデル一覧取得等）を送信する

**36. プロキシ設定の適用**

When 接続テストが実行された, the システム shall 現在のプロキシ設定を使用してリクエストを送信する

**37. 証明書設定の適用**

When 接続テストが実行された, the システム shall 現在の証明書設定を使用してHTTPS接続を確立する

**38. タイムアウト設定**

The システム shall 接続テストのタイムアウトを30秒に設定する

#### 3.4.3 テスト成功の処理

**39. 成功メッセージの表示**

When 接続テストが成功した, the システム shall 成功メッセージと応答時間（ミリ秒）を表示する

**40. 取得データの表示**

When 接続テストが成功した, the システム shall 取得されたデータのサンプル（モデル数等）を表示する

#### 3.4.4 テスト失敗の処理

**41. エラーカテゴリの特定**

If 接続テストが失敗した, the システム shall エラーをカテゴリ別（ネットワークエラー、認証エラー、プロキシエラー、証明書エラー）に分類する

**42. ネットワークエラーの詳細表示**

If 接続テストがネットワークエラー（タイムアウト、接続拒否）で失敗した, the システム shall エラーメッセージと推奨される対処法（プロキシ設定確認、ファイアウォール確認）を表示する

**43. 認証エラーの詳細表示**

If 接続テストが認証エラー（401、403）で失敗した, the システム shall APIキーが無効である可能性を示すエラーメッセージを表示する

**44. プロキシエラーの詳細表示**

If 接続テストがプロキシエラー（407 Proxy Authentication Required、ECONNREFUSED to proxy）で失敗した, the システム shall プロキシ設定の誤り、認証情報の誤りを示すエラーメッセージを表示する

**45. 証明書エラーの詳細表示**

If 接続テストが証明書エラー（CERT_HAS_EXPIRED、UNABLE_TO_VERIFY_LEAF_SIGNATURE）で失敗した, the システム shall 証明書設定の誤り、カスタムCA証明書の追加を示すエラーメッセージを表示する

**46. エラーログの記録**

If 接続テストが失敗した, the システム shall 詳細なエラー情報（エラーコード、スタックトレース、リクエスト詳細）をログファイルに記録する

#### 3.4.5 診断情報の提供

**47. ネットワーク診断情報の表示**

When 接続テストが完了した, the システム shall 使用されたプロキシ設定、証明書設定、DNSルックアップ結果を診断情報として表示する

**48. リトライオプションの提供**

When 接続テストが失敗した, the システム shall 「再試行」ボタンを提供する

---

## 4. テスト可能性

### 4.1 受け入れテストシナリオ

**シナリオ1: プロキシ設定（Custom）**
1. 設定画面でプロキシモードを"Custom"に変更
2. プロキシURL: "proxy.company.com:8080"を入力
3. プロキシ認証（ユーザー名: "user"、パスワード: "pass"）を入力
4. 設定を保存
5. OpenAI設定で接続テストを実行
6. テストが成功し、応答時間が表示されることを確認
7. AIチャットでメッセージを送信し、プロキシ経由で通信できることを確認

**シナリオ2: カスタムCA証明書**
1. 設定画面で証明書モードを"Custom"に変更
2. カスタムCA証明書ファイル（company-ca.pem）を選択
3. 証明書情報（発行者、有効期限）が表示されることを確認
4. 設定を保存
5. Anthropic設定で接続テストを実行
6. テストが成功することを確認

**シナリオ3: 接続テスト失敗診断**
1. プロキシモードを"Custom"に設定し、無効なプロキシURL "invalid:9999"を入力
2. 設定を保存
3. 接続テストを実行
4. プロキシエラー（ECONNREFUSED to proxy）が検出されることを確認
5. エラーメッセージに対処法（プロキシ設定確認）が表示されることを確認
6. プロキシURLを修正して再試行
7. テストが成功することを確認

### 4.2 検証基準

- プロキシ・証明書設定が全てのHTTP/HTTPSリクエストに適用される
- 接続テストが全てのエラーカテゴリを正確に分類する
- エラーメッセージが具体的な対処法を含む
- Windows環境でシステムプロキシ・証明書が正常に検出される
- macOS/Linux環境で非サポートが明確に通知される

---

## 5. 非機能要件

### 5.1 セキュリティ

**49. 認証情報の保護**

The システム shall プロキシ認証情報をデータベースに平文で保存し、userDataディレクトリのパーミッションで保護する

**50. 証明書検証無効化の制限**

The システム shall 証明書検証を無効化する際にセキュリティリスクを明確に警告する

### 5.2 互換性

**51. Windows証明書ストアの統合**

The システム shall Windows環境でシステム証明書ストアから証明書を自動的に読み込む

**52. macOS/Linux環境での明確な案内**

The システム shall macOS/Linux環境でシステムプロキシ・証明書の自動検出がサポートされていないことを明確に通知する

### 5.3 ユーザビリティ

**53. エラーメッセージの明確性**

The システム shall 接続エラーメッセージに問題の原因と推奨される対処法を含める

**54. 設定の検証**

The システム shall ユーザーが設定を保存する前に基本的な形式検証を実行する

---

## 6. 関連文書

- [要件定義概要](./REQUIREMENTS_OVERVIEW.md)
- [プロキシ・証明書設計](./PROXY_AND_CERTIFICATE_DESIGN.md)
- [プロキシ設定ガイド](./PROXY_CONFIGURATION.md)

---

**作成者メモ**: 本文書はEARSフォーマットに従い、テスト可能な要件として記述されています。企業ネットワーク環境でのAI接続を重視しています。
