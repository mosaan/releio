# AI会話要件

## ドキュメント情報

- **作成日**: 2025-11-18
- **バージョン**: 3.0（ユーザーゴール単位での再設計）
- **対象ユースケース**: UC-CHAT-01 〜 UC-CHAT-06（6個のユースケース）
- **関連設計**: [MCP統合設計](./MCP_INTEGRATION_DESIGN.md), [チャットエラーハンドリング](./CHAT_ERROR_HANDLING_DESIGN.md), [会話履歴圧縮](./CONVERSATION_HISTORY_COMPRESSION_DESIGN.md), [チャットセッション永続化](./CHAT_SESSION_PERSISTENCE.md)
- **注記**: 内部処理（検証、永続化、ストリーミング受信等）は各ユースケースの基本フローに統合されています。

---

## 改訂履歴

**v3.0 (2025-11-18)**
- ユーザーゴール単位での全面再設計（12個 → 6個のユースケース）
- 内部処理ユースケースを削除し、主ユースケースの要件に統合
- UC-CHAT-01にチャット開始前の検証とモデル選択永続化を統合
- UC-CHAT-02にメッセージ永続化とストリーミング受信を統合
- UC-CHAT-03（モデル/プロバイダー切り替え）を新規追加
- UC-CHAT-07（履歴復元）をUC-SESS-02に移動
- UC-CHAT-09（圧縮マーカー）を削除（UI実装詳細）
- UC-CHAT-10（ツール確認）をUC-MCP-05に移動
- UC-CHAT-11（メッセージ復元）をUC-CHAT-02のエラーフローに統合

**v2.1 (2025-11-18)**
- UML標準に準拠したユースケース構造に改訂
- UC-CHAT-05「送信前の自動圧縮」を削除し、UC-CHAT-04のALTフローとして統合
- 独立した「会話履歴を圧縮する」ユースケース（UC-SESS-04）への参照に変更
- ユースケース番号を繰り上げ（UC-CHAT-06~14 → UC-CHAT-05~13）

**v2.0 (2025-11-18)**
- コードベース調査に基づき全面改訂
- 10個の新規ユースケースを追加
- 要件数を58から115に拡充
- 実装済み機能を完全に文書化

**v1.0 (初版)**
- 基本的なチャット機能のみ（4個のユースケース）

---

## 1. UC-CHAT-01: チャットを開始する

### 1.1 ユースケース概要

ユーザーがプロバイダーとモデルを選択してチャットセッションを開始します。システムは自動的に設定を検証し、選択されたモデルを永続化します。

### 1.2 事前条件

- The システム shall アプリケーションが起動している

### 1.3 事後条件

- The システム shall プロバイダーとモデルが選択されている
- The システム shall モデル選択がlocalStorageに保存されている
- The システム shall チャット画面が使用可能な状態である

### 1.4 要件

#### 1.4.1 起動時の自動検証（内部処理）

**1. チャット画面起動時の検証**

When ユーザーがチャット画面を開いた, the システム shall プロバイダー設定の存在を自動的に確認する

**2. プロバイダー設定の存在チェック**

When システムがプロバイダー設定を確認する, the システム shall AISettingsV2のproviderConfigsが1つ以上存在するかチェックする

**3. プロバイダー設定不在時の表示**

If プロバイダー設定が1つも存在しない, the システム shall 「No AI Provider Configured」エラーを表示し、設定画面へのリンクを提供する

**4. 利用可能なモデルの確認**

When プロバイダー設定が存在する, the システム shall 有効なプロバイダー設定に少なくとも1つのモデルが存在するかチェックする

**5. モデル不在時の表示**

If 全てのプロバイダー設定にモデルが存在しない, the システム shall 「No Available Models」エラーを表示し、設定画面へのリンクを提供する

**6. モデル未選択時の警告**

When モデルが選択されていない, the システム shall 「Model Not Selected」警告を表示し、モデル選択を促す

**7. チャット画面の状態表示**

The システム shall チャット画面に現在の状態（設定なし / モデルなし / モデル未選択 / 使用可能）を明確に表示する

#### 1.4.2 モデル選択

**8. モデルセレクターの提供**

The システム shall チャット画面にプロバイダーとモデルを選択できるセレクターを提供する

**9. プロバイダーごとのモデル一覧表示**

When ユーザーがモデルセレクターを開いた, the システム shall プロバイダーごとにグループ化されたモデル一覧を表示する

**10. 選択時の即座保存（内部処理）**

When ユーザーがモデルを選択した, the システム shall 選択内容（providerConfigId、modelId）をJSON形式でlocalStorageに即座に保存する

**11. localStorageキーの定義（内部処理）**

The システム shall モデル選択の保存に`ai-last-model-selection`キーを使用する

**12. JSON形式での保存（内部処理）**

The システム shall モデル選択を以下のJSON形式で保存する：
```json
{
  "providerConfigId": "uuid-string",
  "modelId": "model-id-string"
}
```

#### 1.4.3 モデル選択の復元（内部処理）

**13. 起動時の自動復元**

When チャット画面が起動した, the システム shall localStorageから最後のモデル選択を読み込み、復元する

**14. 保存されたモデル選択の検証**

When システムが起動した, the システム shall localStorageに保存されたモデル選択（providerConfigId、modelId）の有効性を検証する

**15. 無効なモデル選択のリセット**

If 保存されたモデル選択が無効（設定が削除、無効化、またはモデルが削除）, the システム shall モデル選択をリセットし、localStorageから削除する

**16. 復元失敗時のフォールバック**

If localStorageからの復元に失敗（JSON parse エラー）, the システム shall モデル選択をnullにリセットし、localStorageから無効なデータを削除する

---

## 2. UC-CHAT-02: メッセージを送信する

### 2.1 ユースケース概要

ユーザーがAIに対してテキストメッセージを送信し、ストリーミング形式で応答を受信します。メッセージとAI応答は自動的にデータベースに保存されます。

### 2.2 事前条件

- The システム shall モデルが選択されている
- The システム shall 選択されたプロバイダー設定に有効なAPIキーが設定されている

### 2.3 事後条件

- The システム shall ユーザーメッセージがチャット履歴に追加されている
- The システム shall ユーザーメッセージとAI応答がデータベースに保存されている
- The システム shall AIへのリクエストが送信され、応答が表示されている

### 2.4 要件

#### 2.4.1 メッセージ入力

**17. メッセージ入力フィールドの提供**

The システム shall チャット画面にメッセージ入力フィールド（テキストエリア）を提供する

**18. 送信ボタンの提供**

The システム shall メッセージ入力フィールドに隣接して送信ボタンを提供する

**19. キーボードショートカット**

When ユーザーがメッセージ入力フィールドでEnterキーを押下した, the システム shall メッセージを送信する（Shift+Enterで改行）

#### 2.4.2 送信前のバリデーション

**20. 空メッセージの送信防止**

If ユーザーが空白のみのメッセージを送信しようとした, the システム shall 送信を無効化し、送信ボタンをグレーアウトする

**21. モデル未選択時の送信防止**

If ユーザーがモデルを選択せずにメッセージを送信しようとした, the システム shall エラーメッセージを表示し、モデル選択を促す

**22. API接続中の多重送信防止**

While システムがAIからの応答を待機している, the システム shall 送信ボタンを無効化し、新しいメッセージの送信を防止する

#### 2.4.3 メッセージの送信

**23. ユーザーメッセージの即時表示**

When ユーザーがメッセージを送信した, the システム shall ユーザーメッセージをチャット履歴に即座に表示する

**24. 入力フィールドのクリア**

When ユーザーがメッセージを送信した, the システム shall メッセージ入力フィールドをクリアする

**25. AIリクエストの送信**

When ユーザーがメッセージを送信した, the システム shall 選択されたモデルとメッセージ履歴を含むリクエストをBackendプロセスに送信する

**26. MCPツールの自動提供**

When ユーザーがメッセージを送信した, the システム shall 有効化された全てのMCPサーバーのツールをAIリクエストに含める

#### 2.4.4 トークン制限チェック（ALTフロー）

このサブセクションでは、トークン制限に達した際の自動圧縮処理（UC-SESS-04の条件付き呼び出し）を定義します。

**27. トークン制限のチェック**

When ユーザーがメッセージを送信しようとした, the システム shall 現在の会話履歴のトークン数を計算する

**28. 自動圧縮の判定**

If トークン数が設定された閾値を超過しており、かつ自動圧縮設定（autoCompress）が有効である, the システム shall UC-SESS-04（会話履歴を圧縮する）を呼び出す

**29. 圧縮後の送信継続**

When UC-SESS-04による圧縮が成功した, the システム shall 圧縮後の会話履歴を使用してメッセージ送信を継続する

**30. 圧縮失敗時の処理**

If UC-SESS-04による圧縮に失敗した, the システム shall エラーをログに記録し、圧縮せずにメッセージ送信を継続する

**31. 圧縮実行のログ記録**

When UC-SESS-04が呼び出された, the システム shall 圧縮前後のトークン数と圧縮理由（自動/手動）をログに記録する

#### 2.4.5 メッセージの永続化（内部処理）

**32. 送信前の保存**

When ユーザーがメッセージを送信した, the システム shall ストリーミング開始前にユーザーメッセージをデータベースに保存する

**33. メッセージ形式の定義**

When ユーザーメッセージを保存する, the システム shall 以下の形式でAddMessageRequestを作成する：
```typescript
{
  sessionId: string,
  role: 'user',
  parts: [{ kind: 'text', content: string }]
}
```

**34. 保存成功のログ記録**

When ユーザーメッセージが保存された, the システム shall メッセージIDと内容プレビュー（最大50文字）をログに記録する

**35. 保存失敗時の継続**

If ユーザーメッセージの保存に失敗した, the システム shall エラーをログに記録し、ストリーミングを継続する

#### 2.4.6 ストリーミング応答の受信（内部処理）

**36. AIメッセージプレースホルダーの表示**

When AIからの応答が開始された, the システム shall チャット履歴にAIメッセージのプレースホルダーを表示する

**37. ローディングインジケーターの表示**

While システムがAIからの最初のトークンを待機している, the システム shall AIメッセージにローディングインジケーター（タイピングアニメーション等）を表示する

**38. 初回トークン表示の低遅延**

When AIから最初のトークンを受信した, the システム shall 100ms以内にユーザーに表示を開始する

**39. リアルタイムテキスト表示**

While システムがAIからテキストトークンを受信している, the システム shall 受信したトークンを即座にAIメッセージに追加表示する

**40. 自動スクロール**

While システムがストリーミング応答を受信している, the システム shall チャット画面を自動的に最新メッセージまでスクロールする

**41. Markdownレンダリング**

The システム shall AIの応答をMarkdown形式でレンダリングする（コードブロック、リスト、太字等のサポート）

**42. コードブロックのシンタックスハイライト**

When AIの応答にコードブロックが含まれる, the システム shall プログラミング言語に応じたシンタックスハイライトを適用する

#### 2.4.7 ストリーミング完了（内部処理）

**43. 完了状態の表示**

When AIからの応答が完了した, the システム shall ローディングインジケーターを非表示にする

**44. AI応答の保存**

When AI応答のストリーミングが完了した, the システム shall 完全な応答内容をデータベースに保存する

**45. パーツの保存**

When AI応答を保存する, the システム shall テキストパーツとツール呼び出しパーツを全て保存する

**46. ツール呼び出しの保存**

When AI応答にツール呼び出しが含まれる, the システム shall ツール呼び出しを以下の形式で保存する：
```typescript
{
  kind: 'tool_invocation',
  toolCallId: string,
  toolName: string,
  input: unknown
}
```

**47. ツール結果の保存**

When ツール実行が完了した, the システム shall ツール結果をRecordToolInvocationResultRequestとして別途保存する

**48. トークン使用量の記録**

When AIからの応答が完了した, the システム shall 使用されたトークン数（入力トークン、出力トークン、合計）をログに記録する

#### 2.4.8 エラーハンドリング

エラーハンドリングの詳細は、UC-CHAT-05, UC-CHAT-06を参照してください。

**49. ネットワークエラーの処理**

If メッセージ送信中にネットワークエラーが発生した, the システム shall UC-CHAT-05のエラー分類に従ってエラーを処理する

**50. 認証エラーの処理**

If メッセージ送信中に認証エラー（401、403）が発生した, the システム shall UC-CHAT-05のエラー分類に従ってエラーを処理する

**51. レート制限エラーの処理**

If メッセージ送信中にレート制限エラー（429）が発生した, the システム shall UC-CHAT-05のエラー分類に従ってエラーを処理する

**52. エラー発生時の即座復元（内部処理）**

When メッセージ送信がエラーで失敗した, the システム shall 失敗したメッセージを入力フィールドに即座に復元する

**53. 元のメッセージの保持**

When メッセージが復元された, the システム shall 元のメッセージ内容を完全に保持する（改行、空白を含む）

**54. カーソル位置の設定**

When メッセージが復元された, the システム shall カーソルを入力フィールドの末尾に配置する

---

## 3. UC-CHAT-03: モデル/プロバイダーを切り替える

### 3.1 ユースケース概要

ユーザーが会話中に使用するAIモデルやプロバイダーを変更します。

### 3.2 事前条件

- The システム shall チャットセッションが存在する
- The システム shall 少なくとも1つのプロバイダー設定が有効である

### 3.3 事後条件

- The システム shall 新しいモデルが選択されている
- The システム shall 新しいモデル選択がlocalStorageに保存されている

### 3.4 要件

#### 3.4.1 モデル切り替え操作

**55. モデル切り替えの提供**

The システム shall チャット画面のモデルセレクターから別のモデルに切り替えできる機能を提供する

**56. 会話中の切り替え**

The システム shall 会話の途中でもモデルを切り替えできるようにする

**57. 即座の反映**

When ユーザーがモデルを切り替えた, the システム shall 次のメッセージ送信時から新しいモデルを使用する

**58. 履歴の保持**

When ユーザーがモデルを切り替えた, the システム shall 既存の会話履歴を保持する

#### 3.4.2 切り替えの永続化（内部処理）

**59. 切り替え時の保存**

When ユーザーがモデルを切り替えた, the システム shall 新しいモデル選択をlocalStorageに保存する

**60. 切り替えのログ記録**

When ユーザーがモデルを切り替えた, the システム shall 旧モデル、新モデル、切り替え時刻をログに記録する

---

## 4. UC-CHAT-04: ストリーミングを中断する

### 4.1 ユースケース概要

ユーザーがAI応答のストリーミング中に生成を中断します。

### 4.2 事前条件

- The システム shall AIからの応答をストリーミング中である

### 4.3 事後条件

- The システム shall ストリーミングが停止している
- The システム shall 中断時点までの部分応答が保存されている

### 4.4 要件

#### 4.4.1 中断操作

**61. 停止ボタンの提供**

While システムがストリーミング応答を受信している, the システム shall 「停止」ボタンを表示する

**62. AbortSignalの送信**

When ユーザーが停止ボタンをクリックした, the システム shall AbortSignalをBackendプロセスに送信する

**63. Backendへの中断リクエスト**

When AbortSignalが送信された, the システム shall window.backend.abortAIText(sessionId)を呼び出す

#### 4.4.2 中断処理（内部処理）

**64. ストリーミングループの終了**

When Backendが中断リクエストを受信した, the システム shall ストリーミングループを終了する

**65. 中断イベントの送信**

When ストリーミングが中断された, the システム shall aiChatAbortedイベントをRendererに送信する

**66. 部分応答の保存**

When ストリーミングが中断された, the システム shall 中断時点までの部分応答をデータベースに保存する

#### 4.4.3 UI状態の更新（内部処理）

**67. ローディング状態の解除**

When 中断イベントを受信した, the システム shall ローディングインジケーターを非表示にする

**68. 入力フィールドの再有効化**

When 中断イベントを受信した, the システム shall メッセージ入力フィールドと送信ボタンを再有効化する

**69. 中断メッセージの表示**

When ストリーミングが中断された, the システム shall チャット履歴に「応答が中断されました」というシステムメッセージを表示する

---

## 5. UC-CHAT-05: エラー詳細を確認する

### 5.1 ユースケース概要

メッセージ送信が失敗した場合、エラーの種類を分類し、詳細情報と推奨対処法を表示します。

### 5.2 事前条件

- The システム shall メッセージ送信またはストリーミング中にエラーが発生している

### 5.3 事後条件

- The システム shall エラーメッセージがチャット履歴に表示されている
- The システム shall エラー詳細が展開可能な形式で表示されている

### 5.4 要件

#### 5.4.1 エラーの分類（内部処理）

**70. エラーカテゴリーの定義**

The システム shall エラーを以下のカテゴリーに分類する：
- ネットワークエラー（接続タイムアウト、DNS解決失敗）
- 認証エラー（HTTP 401、403）
- レート制限エラー（HTTP 429）
- プロバイダーエラー（HTTP 4xx、5xx）
- 不明なエラー（その他）

**71. エラーカテゴリーの判定**

When エラーが発生した, the システム shall エラーの種類、HTTPステータスコード、エラーメッセージに基づいてカテゴリーを判定する

#### 5.4.2 エラーメッセージの表示

**72. 統一されたエラーメッセージ**

When エラーが発生した, the システム shall チャット履歴に「メッセージの送信に失敗しました」という統一されたエラーメッセージを表示する

**73. エラーアイコンの表示**

The システム shall エラーメッセージに警告アイコン（⚠️）を表示する

**74. 視覚的な区別**

The システム shall エラーメッセージを薄いオレンジ背景（bg-orange-50）と境界線（border-orange-200）で表示する

#### 5.4.3 詳細情報の展開表示

**75. 詳細表示ボタンの提供**

The システム shall エラーメッセージに「詳細を表示」ボタンを提供する

**76. 詳細情報の内容**

When ユーザーが詳細を表示ボタンをクリックした, the システム shall 以下の情報を表示する：
- HTTPステータスコード（該当する場合）
- エラーコード（プロバイダー固有）
- エラーメッセージ（技術的詳細）
- タイムスタンプ（ISO 8601形式）

**77. 推奨対処法の表示**

When 詳細情報が表示された, the システム shall エラーカテゴリーに応じた推奨対処法を表示する：
- ネットワークエラー: プロキシ設定、ファイアウォール確認を促す
- 認証エラー: API キーの確認を促す、設定画面へのリンク
- レート制限エラー: しばらく待つよう促す
- プロバイダーエラー: プロバイダーからのエラーメッセージを表示
- 不明なエラー: 技術的なエラーメッセージを表示

#### 5.4.4 ログ記録（内部処理）

**78. エラーログの記録**

When エラーが発生した, the システム shall 詳細なエラー情報（カテゴリー、ステータスコード、メッセージ、スタックトレース）をログファイルに記録する

**79. ログプレフィックスの使用**

The システム shall エラーログに`[AI]`, `[CHAT]`, `[ERROR]`プレフィックスを使用し、識別しやすくする

---

## 6. UC-CHAT-06: メッセージを再送信する

### 6.1 ユースケース概要

ユーザーが失敗したメッセージを編集または修正して再送信します。

### 6.2 事前条件

- The システム shall UC-CHAT-02によってメッセージが入力フィールドに復元されている

### 6.3 事後条件

- The システム shall 修正されたメッセージが送信されている

### 6.4 要件

#### 6.4.1 再送信操作

**80. 再送信ボタンの提供**

When メッセージが復元された, the システム shall 通常の送信ボタンで再送信できるようにする（特別な「再送信」ボタンは不要）

**81. 編集可能状態**

When メッセージが復元された, the システム shall ユーザーがメッセージを自由に編集できる状態にする

**82. リトライカウンターの非表示**

The システム shall リトライ回数を追跡しない（ユーザーは何度でも再送信可能）

**83. クリアオプション**

The システム shall ユーザーが復元されたメッセージをクリアできるオプションを提供する

---

## 7. テスト可能性

### 7.1 受け入れテストシナリオ

**シナリオ1: チャット開始とモデル選択の永続化**
1. アプリケーションを起動（初回起動、プロバイダー設定なし）
2. チャット画面を開く
3. 「No AI Provider Configured」エラーが表示されることを確認
4. 設定画面でOpenAI設定を追加
5. チャット画面に戻る
6. 「No Available Models」エラーが表示されることを確認
7. 設定画面でモデルリストを更新
8. チャット画面に戻る
9. モデルセレクターから"gpt-4o"を選択
10. アプリケーションを再起動
11. チャット画面で"gpt-4o"が自動選択されていることを確認（localStorage復元）

**シナリオ2: メッセージ送信と永続化**
1. チャット画面で「こんにちは」とメッセージを送信
2. ユーザーメッセージがチャット履歴に即座に表示されることを確認
3. AIメッセージプレースホルダーが表示されることを確認
4. AI応答がストリーミング形式で表示されることを確認
5. データベースにユーザーメッセージとAI応答が保存されていることを確認（sqlite3コマンドで検証）

**シナリオ3: モデル切り替え**
1. チャット画面で"gpt-4o"を選択し、「こんにちは」と送信
2. 応答を確認
3. モデルセレクターから"claude-3-5-sonnet-20241022"に切り替え
4. 「こんにちは」と送信
5. 新しいモデルで応答が生成されることを確認
6. 既存の会話履歴が保持されていることを確認
7. アプリケーションを再起動
8. "claude-3-5-sonnet-20241022"が自動選択されていることを確認

**シナリオ4: ストリーミングの中断**
1. チャット画面で長い応答を生成するメッセージを送信（例: 「1000語のエッセイを書いて」）
2. ストリーミング開始後、3秒待つ
3. 停止ボタンをクリック
4. ストリーミングが即座に停止することを確認
5. 中断時点までの部分応答が表示されることを確認
6. 部分応答がデータベースに保存されていることを確認
7. 入力フィールドが再有効化されることを確認

**シナリオ5: エラー時のメッセージ復元と再送信**
1. プロバイダー設定のAPIキーを無効な値に変更
2. チャット画面で「こんにちは」とメッセージを送信
3. 認証エラーメッセージが表示されることを確認
4. 入力フィールドに「こんにちは」が自動復元されることを確認
5. 「詳細を表示」ボタンをクリック
6. HTTPステータスコード401、推奨対処法（API キー確認）が表示されることを確認
7. 設定画面でAPIキーを修正
8. チャット画面に戻る
9. 復元された「こんにちは」をそのまま送信ボタンで再送信
10. 正常に送信され、AI応答が表示されることを確認

### 7.2 検証基準

- チャット使用前の検証が全ての状態（設定なし、モデルなし、モデル未選択）を適切に検出する
- モデル選択がlocalStorageに保存され、次回起動時に正しく復元される
- モデル切り替えが即座に反映され、既存の会話履歴が保持される
- 全てのメッセージ（ユーザー、AI、ツール呼び出し）がデータベースに保存される
- ストリーミングが中断された場合でも部分応答が保存される
- エラーが発生した場合、メッセージが失われず、再送信が容易である
- エラーが適切に分類され、詳細情報と推奨対処法が表示される

---

## 8. 非機能要件

### 8.1 パフォーマンス

**NFR-1: ストリーミング応答の低遅延**

The システム shall AIから受信した最初のトークンを100ms以内にユーザーに表示する

**NFR-2: UI応答性の維持**

While システムがストリーミング応答を処理している, the システム shall UIの応答性を維持し、ユーザーの操作を受け付ける

### 8.2 セキュリティ

**NFR-3: APIキーの非表示**

The システム shall ログファイルやエラーメッセージにAPIキーを含めない

**NFR-4: ツール実行の透明性**

The システム shall AIによる全てのツール実行をユーザーに可視化する（UC-MCP-05参照）

### 8.3 データ整合性

**NFR-5: メッセージの原子性**

The システム shall メッセージ保存操作をアトミックに実行し、部分的な保存を防止する

**NFR-6: ストリーミング中断時のデータ保護**

If ストリーミングが中断された, the システム shall 中断時点までのデータを確実に保存する

### 8.4 ユーザビリティ

**NFR-7: エラーメッセージの明確性**

The システム shall エラーメッセージに問題の原因と推奨される対処法を含める

**NFR-8: メッセージの非破壊性**

The システム shall エラー発生時もユーザーが入力した内容を失わない

---

## 9. 関連文書

- [要件定義概要](./REQUIREMENTS_OVERVIEW.md)
- [MCP統合設計](./MCP_INTEGRATION_DESIGN.md)
- [チャットエラーハンドリング設計](./CHAT_ERROR_HANDLING_DESIGN.md)
- [会話履歴圧縮設計](./CONVERSATION_HISTORY_COMPRESSION_DESIGN.md)
- [チャットセッション永続化設計](./CHAT_SESSION_PERSISTENCE.md)

---

## 10. 実装ファイル参照

以下のファイルが本要件の実装を担当しています（参考情報）：

- `src/renderer/src/components/ChatPage.tsx` (UC-CHAT-01: チャット開始前の検証)
- `src/renderer/src/components/AIRuntimeProvider.tsx` (UC-CHAT-02: 自動圧縮、メッセージ永続化)
- `src/renderer/src/lib/ai.ts` (UC-CHAT-02,04: ストリーミングイベント処理、中断)
- `src/backend/ai/stream.ts` (UC-CHAT-02: ツール呼び出し、ログ記録)

---

**作成者メモ**: 本文書（v3.0）はユーザーゴール単位での全面再設計版です。内部処理ユースケースを削除し、主ユースケース6個に統合しました。全ての要件はEARSフォーマットに従い、テスト可能な形式で記述されています。
