# AI会話要件（拡充版）

## ドキュメント情報

- **作成日**: 2025-11-18
- **バージョン**: 2.1（ユースケース構造改訂）
- **対象ユースケース**: UC-CHAT-02 〜 UC-CHAT-13（12個のユースケース）
- **関連設計**: [MCP統合設計](./MCP_INTEGRATION_DESIGN.md), [チャットエラーハンドリング](./CHAT_ERROR_HANDLING_DESIGN.md), [会話履歴圧縮](./CONVERSATION_HISTORY_COMPRESSION_DESIGN.md), [チャットセッション永続化](./CHAT_SESSION_PERSISTENCE.md)
- **注記**: UC-CHAT-01（チャットを開始する）は別途定義。UC-CHAT-05（送信前の自動圧縮）はUC-CHAT-04のALTフローとUC-SESS-04への参照として統合。

---

## 改訂履歴

**v2.1 (2025-11-18)**
- UML標準に準拠したユースケース構造に改訂
- UC-CHAT-05「送信前の自動圧縮」を削除し、UC-CHAT-04のALTフローとして統合
- 独立した「会話履歴を圧縮する」ユースケース（UC-SESS-04）への参照に変更
- ユースケース番号を繰り上げ（UC-CHAT-06~14 → UC-CHAT-05~13）

**v2.0 (2025-11-18)**
- コードベース調査に基づき全面改訂
- 10個の新規ユースケースを追加
- 要件数を58から115に拡充
- 実装済み機能を完全に文書化

**v1.0 (初版)**
- 基本的なチャット機能のみ（4個のユースケース）

---

## 1. UC-CHAT-02: チャット使用前の検証

### 1.1 ユースケース概要

ユーザーがチャット画面を開いたときに、システムがプロバイダー設定とモデルの存在を自動的に確認し、チャット使用可能性を検証します。

### 1.2 事前条件

- The システム shall アプリケーションが起動している

### 1.3 事後条件

- The システム shall チャット使用可能性（プロバイダー設定の有無、モデルの有無）が判定されている
- If チャット使用が不可能, the システム shall ユーザーに適切なガイダンスを表示している

### 1.4 要件

#### 1.4.1 起動時の自動検証

**1. チャット画面起動時の検証**

When ユーザーがチャット画面を開いた, the システム shall プロバイダー設定の存在を自動的に確認する

**2. プロバイダー設定の存在チェック**

When システムがプロバイダー設定を確認する, the システム shall AISettingsV2のproviderConfigsが1つ以上存在するかチェックする

**3. プロバイダー設定不在時の表示**

If プロバイダー設定が1つも存在しない, the システム shall 「No AI Provider Configured」エラーを表示し、設定画面へのリンクを提供する

#### 1.4.2 モデル存在の検証

**4. 利用可能なモデルの確認**

When プロバイダー設定が存在する, the システム shall 有効なプロバイダー設定に少なくとも1つのモデルが存在するかチェックする

**5. モデル不在時の表示**

If 全てのプロバイダー設定にモデルが存在しない, the システム shall 「No Available Models」エラーを表示し、設定画面へのリンクを提供する

**6. モデル未選択時の警告**

When モデルが選択されていない, the システム shall 「Model Not Selected」警告を表示し、モデル選択を促す

#### 1.4.3 選択済みモデルの検証

**7. 保存されたモデル選択の検証**

When システムが起動した, the システム shall localStorageに保存されたモデル選択（providerConfigId、modelId）の有効性を検証する

**8. 無効なモデル選択のリセット**

If 保存されたモデル選択が無効（設定が削除、無効化、またはモデルが削除）, the システム shall モデル選択をリセットし、localStorageから削除する

**9. チャット画面の状態表示**

The システム shall チャット画面に現在の状態（設定なし / モデルなし / モデル未選択 / 使用可能）を明確に表示する

---

## 2. UC-CHAT-03: モデル選択の永続化

### 2.1 ユースケース概要

ユーザーが選択したモデルをlocalStorageに自動保存し、次回起動時に復元します。

### 2.2 事前条件

- The システム shall チャット画面が表示されている

### 2.3 事後条件

- The システム shall ユーザーが選択したモデルがlocalStorageに保存されている

### 2.4 要件

#### 2.4.1 モデル選択の保存

**10. 選択時の即座保存**

When ユーザーがモデルを選択した, the システム shall 選択内容（providerConfigId、modelId）をJSON形式でlocalStorageに即座に保存する

**11. localStorageキーの定義**

The システム shall モデル選択の保存に`ai-last-model-selection`キーを使用する

**12. JSON形式での保存**

The システム shall モデル選択を以下のJSON形式で保存する：
```json
{
  "providerConfigId": "uuid-string",
  "modelId": "model-id-string"
}
```

#### 2.4.2 モデル選択の復元

**13. 起動時の自動復元**

When チャット画面が起動した, the システム shall localStorageから最後のモデル選択を読み込み、復元する

**14. 復元失敗時のフォールバック**

If localStorageからの復元に失敗（JSON parse エラー）, the システム shall モデル選択をnullにリセットし、localStorageから無効なデータを削除する

**15. 復元後の検証**

When モデル選択が復元された, the システム shall 復元された選択が現在の設定で有効かUC-CHAT-02の要件7に従って検証する

---

## 3. UC-CHAT-04: メッセージを送信する

### 3.1 ユースケース概要

ユーザーがAIに対してテキストメッセージを送信します。

### 3.2 事前条件

- The システム shall モデルが選択されている
- The システム shall 選択されたプロバイダー設定に有効なAPIキーが設定されている

### 3.3 事後条件

- The システム shall ユーザーメッセージがチャット履歴に追加されている
- The システム shall AIへのリクエストが送信されている

### 3.4 要件

#### 3.4.1 メッセージ入力

**16. メッセージ入力フィールドの提供**

The システム shall チャット画面にメッセージ入力フィールド（テキストエリア）を提供する

**17. 送信ボタンの提供**

The システム shall メッセージ入力フィールドに隣接して送信ボタンを提供する

**18. キーボードショートカット**

When ユーザーがメッセージ入力フィールドでEnterキーを押下した, the システム shall メッセージを送信する（Shift+Enterで改行）

#### 3.4.2 送信前のバリデーション

**19. 空メッセージの送信防止**

If ユーザーが空白のみのメッセージを送信しようとした, the システム shall 送信を無効化し、送信ボタンをグレーアウトする

**20. モデル未選択時の送信防止**

If ユーザーがモデルを選択せずにメッセージを送信しようとした, the システム shall エラーメッセージを表示し、モデル選択を促す

**21. API接続中の多重送信防止**

While システムがAIからの応答を待機している, the システム shall 送信ボタンを無効化し、新しいメッセージの送信を防止する

#### 3.4.3 メッセージの送信

**22. ユーザーメッセージの即時表示**

When ユーザーがメッセージを送信した, the システム shall ユーザーメッセージをチャット履歴に即座に表示する

**23. 入力フィールドのクリア**

When ユーザーがメッセージを送信した, the システム shall メッセージ入力フィールドをクリアする

**24. AIリクエストの送信**

When ユーザーがメッセージを送信した, the システム shall 選択されたモデルとメッセージ履歴を含むリクエストをBackendプロセスに送信する

**25. MCPツールの自動提供**

When ユーザーがメッセージを送信した, the システム shall 有効化された全てのMCPサーバーのツールをAIリクエストに含める

#### 3.4.4 エラーハンドリング

エラーハンドリングの詳細は、UC-CHAT-12, UC-CHAT-13, UC-CHAT-14を参照してください。

**26. ネットワークエラーの処理**

If メッセージ送信中にネットワークエラーが発生した, the システム shall UC-CHAT-13のエラー分類に従ってエラーを処理する

**27. 認証エラーの処理**

If メッセージ送信中に認証エラー（401、403）が発生した, the システム shall UC-CHAT-13のエラー分類に従ってエラーを処理する

**28. レート制限エラーの処理**

If メッセージ送信中にレート制限エラー（429）が発生した, the システム shall UC-CHAT-13のエラー分類に従ってエラーを処理する

#### 3.4.5 送信前の自動圧縮（ALTフロー）

このサブセクションでは、トークン制限に達した際の自動圧縮処理（UC-SESS-04の条件付き呼び出し）を定義します。

**29. トークン制限のチェック**

When ユーザーがメッセージを送信しようとした, the システム shall 現在の会話履歴のトークン数を計算する

**30. 自動圧縮の判定**

If トークン数が設定された閾値を超過しており、かつ自動圧縮設定（autoCompress）が有効である, the システム shall UC-SESS-04（会話履歴を圧縮する）を呼び出す

**31. 圧縮後の送信継続**

When UC-SESS-04による圧縮が成功した, the システム shall 圧縮後の会話履歴を使用してメッセージ送信を継続する

**32. 圧縮失敗時の処理**

If UC-SESS-04による圧縮に失敗した, the システム shall エラーをログに記録し、圧縮せずにメッセージ送信を継続する

**33. 圧縮スキップ条件**

If 自動圧縮設定（autoCompress）が無効である, the システム shall トークン数に関わらず圧縮をスキップし、メッセージ送信を継続する

**34. トークン制限超過の警告**

If トークン数が閾値を超過しているが自動圧縮が無効である, the システム shall ユーザーに警告メッセージを表示する（オプション）

**35. 圧縮実行のログ記録**

When UC-SESS-04が呼び出された, the システム shall 圧縮前後のトークン数と圧縮理由（自動/手動）をログに記録する

---

## 4. UC-CHAT-05: メッセージの永続化

### 4.1 ユースケース概要

ユーザーメッセージとAI応答を即座にデータベースに保存します。

### 4.2 事前条件

- The システム shall チャットセッションIDが存在する

### 4.3 事後条件

- The システム shall ユーザーメッセージとAI応答がデータベースに保存されている

### 4.4 要件

#### 4.4.1 ユーザーメッセージの保存

**36. 送信前の保存**

When ユーザーがメッセージを送信した, the システム shall ストリーミング開始前にユーザーメッセージをデータベースに保存する

**37. メッセージ形式の定義**

When ユーザーメッセージを保存する, the システム shall 以下の形式でAddMessageRequestを作成する：
```typescript
{
  sessionId: string,
  role: 'user',
  parts: [{ kind: 'text', content: string }]
}
```

**38. 保存成功のログ記録**

When ユーザーメッセージが保存された, the システム shall メッセージIDと内容プレビュー（最大50文字）をログに記録する

**39. 保存失敗時の継続**

If ユーザーメッセージの保存に失敗した, the システム shall エラーをログに記録し、ストリーミングを継続する

#### 4.4.2 AI応答の保存

**40. ストリーミング完了後の保存**

When AI応答のストリーミングが完了した, the システム shall 完全な応答内容をデータベースに保存する

**41. パーツの保存**

When AI応答を保存する, the システム shall テキストパーツとツール呼び出しパーツを全て保存する

**42. ツール呼び出しの保存**

When AI応答にツール呼び出しが含まれる, the システム shall ツール呼び出しを以下の形式で保存する：
```typescript
{
  kind: 'tool_invocation',
  toolCallId: string,
  toolName: string,
  input: unknown
}
```

**43. ツール結果の保存**

When ツール実行が完了した, the システム shall ツール結果をRecordToolInvocationResultRequestとして別途保存する

**44. 保存成功のログ記録**

When AI応答が保存された, the システム shall メッセージIDとパーツ数をログに記録する

---

## 6. UC-CHAT-07: ストリーミング応答を受信する

### 5.1 ユースケース概要

ユーザーがAIからのストリーミング形式の応答をリアルタイムで受信し、画面に表示します。

### 5.2 事前条件

- The システム shall ユーザーがメッセージを送信している
- The システム shall AIプロバイダーがストリーミング応答をサポートしている

### 5.3 事後条件

- The システム shall AIの応答がチャット履歴に完全に表示されている
- The システム shall 応答がセッションデータとして保存されている

### 5.4 要件

#### 5.4.1 ストリーミング開始

**45. AIメッセージプレースホルダーの表示**

When AIからの応答が開始された, the システム shall チャット履歴にAIメッセージのプレースホルダーを表示する

**46. ローディングインジケーターの表示**

While システムがAIからの最初のトークンを待機している, the システム shall AIメッセージにローディングインジケーター（タイピングアニメーション等）を表示する

**47. 初回トークン表示の低遅延**

When AIから最初のトークンを受信した, the システム shall 100ms以内にユーザーに表示を開始する

#### 5.4.2 テキストストリーミング

**48. リアルタイムテキスト表示**

While システムがAIからテキストトークンを受信している, the システム shall 受信したトークンを即座にAIメッセージに追加表示する

**49. 自動スクロール**

While システムがストリーミング応答を受信している, the システム shall チャット画面を自動的に最新メッセージまでスクロールする

**50. Markdownレンダリング**

The システム shall AIの応答をMarkdown形式でレンダリングする（コードブロック、リスト、太字等のサポート）

**51. コードブロックのシンタックスハイライト**

When AIの応答にコードブロックが含まれる, the システム shall プログラミング言語に応じたシンタックスハイライトを適用する

#### 5.4.3 イベントベースのストリーミング

**52. チャンクイベントの処理**

When Backendからaiチャットチャンクイベントを受信した, the システム shall チャンク内容をAIメッセージに追加する

**53. ツール呼び出しイベントの処理**

When Backendからaiツール呼び出しイベントを受信した, the システム shall ツールカードをチャット履歴に表示する（UC-CHAT-11参照）

**54. ツール結果イベントの処理**

When Backendからaiツール結果イベントを受信した, the システム shall 対応するツールカードに結果を表示する（UC-CHAT-11参照）

#### 5.4.4 ストリーミング完了

**55. 完了状態の表示**

When AIからの応答が完了した, the システム shall ローディングインジケーターを非表示にする

**56. 応答の永続化**

When AIからの応答が完了した, the システム shall UC-CHAT-06の要件40-44に従ってデータベースに保存する

**57. トークン使用量の記録**

When AIからの応答が完了した, the システム shall 使用されたトークン数（入力トークン、出力トークン、合計）をログに記録する

---

## 7. UC-CHAT-08: セッション履歴の復元

### 6.1 ユースケース概要

過去のチャットセッションのメッセージ履歴をデータベースから読み込み、画面に表示します。

### 6.2 事前条件

- The システム shall ユーザーが過去のセッションを選択している

### 6.3 事後条件

- The システム shall セッションの全メッセージがチャット履歴に表示されている

### 6.4 要件

#### 6.4.1 履歴の読み込み

**58. セッション変更時の読み込み**

When ユーザーが過去のセッションを選択した, the システム shall セッションIDに紐づく全メッセージをデータベースから読み込む

**59. メッセージ形式の変換**

When メッセージが読み込まれた, the システム shall データベース形式（ChatMessageWithParts）からAssistant UI形式（ThreadMessage）に変換する

**60. ツール呼び出しパーツの変換**

When メッセージにツール呼び出しパーツが含まれる, the システム shall 以下の形式でThreadMessageに変換する：
```typescript
{
  type: 'tool-call',
  toolCallId: string,
  toolName: string,
  args: unknown,
  argsText: string,  // JSON.stringify(args, null, 2)
  result: unknown  // ツール結果（別途読み込み）
}
```

**61. 時系列順での表示**

When メッセージが読み込まれた, the システム shall メッセージを時系列順（createdAt昇順）でチャット履歴に表示する

#### 6.4.2 圧縮マーカーの挿入

**62. 圧縮サマリーの確認**

When セッション履歴を読み込む, the システム shall セッションにcompressionSummariesが存在するか確認する

**63. 圧縮マーカーの挿入**

If compressionSummariesが存在する, the システム shall UC-CHAT-10の要件に従って圧縮マーカーをメッセージ履歴に挿入する

**64. ランタイムへのインポート**

When メッセージ変換と圧縮マーカー挿入が完了した, the システム shall ExportedMessageRepository.fromArray()を使用してAssistant UIランタイムにインポートする

#### 6.4.3 履歴読み込みエラーの処理

**65. データベースエラーの処理**

If 履歴読み込み中にデータベースエラーが発生した, the システム shall エラーをログに記録し、空のチャット履歴を表示する

**66. 破損データの処理**

If メッセージデータが破損している, the システム shall エラーをログに記録し、そのメッセージをスキップして残りを読み込む

---

## 8. UC-CHAT-09: ストリーミングの中断

### 7.1 ユースケース概要

ユーザーがAI応答のストリーミング中に生成を中断します。

### 7.2 事前条件

- The システム shall AIからの応答をストリーミング中である

### 7.3 事後条件

- The システム shall ストリーミングが停止している
- The システム shall 中断時点までの部分応答が保存されている

### 7.4 要件

#### 7.4.1 中断操作

**67. 停止ボタンの提供**

While システムがストリーミング応答を受信している, the システム shall 「停止」ボタンを表示する

**68. AbortSignalの送信**

When ユーザーが停止ボタンをクリックした, the システム shall AbortSignalをBackendプロセスに送信する

**69. Backendへの中断リクエスト**

When AbortSignalが送信された, the システム shall window.backend.abortAIText(sessionId)を呼び出す

#### 7.4.2 中断処理

**70. ストリーミングループの終了**

When Backendが中断リクエストを受信した, the システム shall ストリーミングループを終了する

**71. 中断イベントの送信**

When ストリーミングが中断された, the システム shall aiChatAbortedイベントをRendererに送信する

**72. 部分応答の保存**

When ストリーミングが中断された, the システム shall 中断時点までの部分応答をUC-CHAT-06の要件に従ってデータベースに保存する

#### 7.4.3 UI状態の更新

**73. ローディング状態の解除**

When 中断イベントを受信した, the システム shall ローディングインジケーターを非表示にする

**74. 入力フィールドの再有効化**

When 中断イベントを受信した, the システム shall メッセージ入力フィールドと送信ボタンを再有効化する

**75. 中断メッセージの表示**

When ストリーミングが中断された, the システム shall チャット履歴に「応答が中断されました」というシステムメッセージを表示する

---

## 9. UC-CHAT-10: 圧縮マーカーの表示

### 8.1 ユースケース概要

会話履歴が圧縮された箇所にマーカーを表示し、要約内容を確認できるようにします。

### 8.2 事前条件

- The システム shall セッションに圧縮サマリーが存在する

### 8.3 事後条件

- The システム shall 圧縮マーカーがチャット履歴の適切な位置に表示されている

### 8.4 要件

#### 8.4.1 圧縮マーカーの生成

**76. 圧縮サマリーの確認**

When セッション履歴を読み込む, the システム shall CompressionSummary配列が存在するか確認する

**77. マーカーメッセージの生成**

When 圧縮サマリーが存在する, the システム shall 各サマリーに対して以下の形式のシステムメッセージを生成する：
```typescript
{
  role: 'system',
  content: [{ type: 'text', text: summary.summary }],
  metadata: {
    custom: {
      isCompressionMarker: true,
      compressedAt: summary.createdAt,
      originalMessageCount: summary.compressedMessageIds.length
    }
  }
}
```

**78. マーカーの挿入位置**

When 圧縮マーカーを挿入する, the システム shall 圧縮された最後のメッセージの直後に挿入する

#### 8.4.2 マーカーの表示

**79. 視覚的な区別**

The システム shall 圧縮マーカーを通常のメッセージと視覚的に区別して表示する（背景色、アイコン等）

**80. 要約内容の表示**

The システム shall 圧縮マーカーにAIが生成した要約内容を表示する

**81. メタデータの表示**

The システム shall 圧縮マーカーに以下のメタデータを表示する：
- 圧縮日時
- 圧縮されたメッセージ数

#### 8.4.3 送信時のマーカー除外

**82. マーカーのフィルタリング**

When ユーザーが新しいメッセージを送信する, the システム shall 圧縮マーカー（isCompressionMarker: true）をAIに送信するメッセージから除外する

**83. 表示専用マーカー**

The システム shall 圧縮マーカーを表示専用とし、AI API リクエストには含めない

---

## 10. UC-CHAT-11: ツール呼び出しを確認する

### 9.1 ユースケース概要

ユーザーがAIによるMCPツールの実行状況と結果を確認します。

### 9.2 事前条件

- The システム shall 少なくとも1つのMCPサーバーが有効化されている
- The システム shall AIがツール呼び出しをサポートしている

### 9.3 事後条件

- The システム shall ツール呼び出しの詳細がチャット履歴に表示されている
- The システム shall ツール呼び出しがログファイルに記録されている

### 9.4 要件

#### 9.4.1 ツール呼び出しの表示

**84. ツールカードの表示**

When AIがMCPツールを呼び出した, the システム shall チャット履歴にツールカードを表示する

**85. ツール名の表示**

The システム shall ツールカードにツール名（例: "read_file"、"github_search"）を表示する

**86. 実行ステータスの表示**

The システム shall ツールカードに実行ステータス（実行中/完了/エラー）を表示する

**87. 実行中の視覚的フィードバック**

While ツールが実行中, the システム shall ツールカードにローディングインジケーターを表示する

#### 9.4.2 ツール詳細の表示

**88. 展開可能なツールカード**

The システム shall ツールカードをクリックで展開し、詳細情報を表示できるようにする

**89. 引数の表示**

When ツールカードが展開された, the システム shall ツールに渡された引数をJSON形式で表示する

**90. 結果の表示**

When ツールの実行が完了した, the システム shall ツールカードにツールの実行結果を表示する

**91. エラー詳細の表示**

If ツールの実行がエラーで終了した, the システム shall ツールカードにエラーメッセージとスタックトレース（利用可能な場合）を表示する

#### 9.4.3 マルチステップツール呼び出し

**92. ツールチェーンの表示**

When AIが複数のツールを連鎖的に呼び出した, the システム shall 各ツール呼び出しを時系列順にツールカードとして表示する

**93. ステップ数の制限**

The システム shall マルチステップツール呼び出しを最大10ステップまで許可する

**94. 無限ループ防止**

If AIが10ステップ以上のツール呼び出しを試みた, the システム shall ツール呼び出しを停止し、制限に達したことを示すメッセージを表示する

#### 9.4.4 ツールログの記録

**95. ツール呼び出しのログ記録**

When AIがMCPツールを呼び出した, the システム shall ツール名、引数、実行開始時刻をログファイルに記録する

**96. ツール結果のログ記録**

When ツールの実行が完了した, the システム shall ツール名、結果（最大200文字）、実行時間をログファイルに記録する

**97. ツールエラーのログ記録**

If ツールの実行がエラーで終了した, the システム shall ツール名、エラーメッセージ、スタックトレースをログファイルに記録する

---

## 11. UC-CHAT-12: エラー時のメッセージ復元

### 10.1 ユースケース概要

メッセージ送信が失敗した場合、失敗したメッセージを入力フィールドに自動復元します。

### 10.2 事前条件

- The システム shall メッセージ送信が失敗している

### 10.3 事後条件

- The システム shall 失敗したメッセージが入力フィールドに復元されている
- The システム shall ユーザーがメッセージを編集・再送信できる状態である

### 10.4 要件

#### 10.4.1 自動復元

**98. エラー発生時の即座復元**

When メッセージ送信がエラーで失敗した, the システム shall 失敗したメッセージを入力フィールドに即座に復元する

**99. 元のメッセージの保持**

When メッセージが復元された, the システム shall 元のメッセージ内容を完全に保持する（改行、空白を含む）

**100. カーソル位置の設定**

When メッセージが復元された, the システム shall カーソルを入力フィールドの末尾に配置する

#### 10.4.2 編集と再送信

**101. 編集可能状態**

When メッセージが復元された, the システム shall ユーザーがメッセージを自由に編集できる状態にする

**102. 再送信の容易性**

The システム shall ユーザーが送信ボタンをクリックするだけで復元されたメッセージを再送信できるようにする

**103. クリアオプション**

The システム shall ユーザーが復元されたメッセージをクリアできるオプションを提供する

---

## 12. UC-CHAT-13: エラー診断と詳細表示

### 11.1 ユースケース概要

エラーの種類を分類し、詳細情報と推奨対処法を表示します。

### 11.2 事前条件

- The システム shall メッセージ送信またはストリーミング中にエラーが発生している

### 11.3 事後条件

- The システム shall エラーメッセージがチャット履歴に表示されている
- The システム shall エラー詳細が展開可能な形式で表示されている

### 11.4 要件

#### 11.4.1 エラーの分類

**104. エラーカテゴリーの定義**

The システム shall エラーを以下のカテゴリーに分類する：
- ネットワークエラー（接続タイムアウト、DNS解決失敗）
- 認証エラー（HTTP 401、403）
- レート制限エラー（HTTP 429）
- プロバイダーエラー（HTTP 4xx、5xx）
- 不明なエラー（その他）

**105. エラーカテゴリーの判定**

When エラーが発生した, the システム shall エラーの種類、HTTPステータスコード、エラーメッセージに基づいてカテゴリーを判定する

#### 11.4.2 エラーメッセージの表示

**106. 統一されたエラーメッセージ**

When エラーが発生した, the システム shall チャット履歴に「メッセージの送信に失敗しました」という統一されたエラーメッセージを表示する

**107. エラーアイコンの表示**

The システム shall エラーメッセージに警告アイコン（⚠️）を表示する

**108. 視覚的な区別**

The システム shall エラーメッセージを薄いオレンジ背景（bg-orange-50）と境界線（border-orange-200）で表示する

#### 11.4.3 詳細情報の展開表示

**109. 詳細表示ボタンの提供**

The システム shall エラーメッセージに「詳細を表示」ボタンを提供する

**110. 詳細情報の内容**

When ユーザーが詳細を表示ボタンをクリックした, the システム shall 以下の情報を表示する：
- HTTPステータスコード（該当する場合）
- エラーコード（プロバイダー固有）
- エラーメッセージ（技術的詳細）
- タイムスタンプ（ISO 8601形式）

**111. 推奨対処法の表示**

When 詳細情報が表示された, the システム shall エラーカテゴリーに応じた推奨対処法を表示する：
- ネットワークエラー: プロキシ設定、ファイアウォール確認を促す
- 認証エラー: API キーの確認を促す、設定画面へのリンク
- レート制限エラー: しばらく待つよう促す
- プロバイダーエラー: プロバイダーからのエラーメッセージを表示
- 不明なエラー: 技術的なエラーメッセージを表示

#### 11.4.4 ログ記録

**112. エラーログの記録**

When エラーが発生した, the システム shall 詳細なエラー情報（カテゴリー、ステータスコード、メッセージ、スタックトレース）をログファイルに記録する

**113. ログプレフィックスの使用**

The システム shall エラーログに`[AI]`, `[CHAT]`, `[ERROR]`プレフィックスを使用し、識別しやすくする

---

## 13. UC-CHAT-14: メッセージ再送信

### 12.1 ユースケース概要

ユーザーが失敗したメッセージを編集または修正して再送信します。

### 12.2 事前条件

- The システム shall UC-CHAT-12によってメッセージが入力フィールドに復元されている

### 12.3 事後条件

- The システム shall 修正されたメッセージが送信されている

### 12.4 要件

#### 12.4.1 再送信操作

**114. 再送信ボタンの提供**

When メッセージが復元された, the システム shall 通常の送信ボタンで再送信できるようにする（特別な「再送信」ボタンは不要）

**115. リトライカウンターの非表示**

The システム shall リトライ回数を追跡しない（ユーザーは何度でも再送信可能）

---

## 14. テスト可能性

### 14.1 受け入れテストシナリオ

**シナリオ1: チャット使用前の検証とモデル選択の永続化**
1. アプリケーションを起動（初回起動、プロバイダー設定なし）
2. チャット画面を開く
3. 「No AI Provider Configured」エラーが表示されることを確認
4. 設定画面でOpenAI設定を追加
5. チャット画面に戻る
6. 「No Available Models」エラーが表示されることを確認
7. 設定画面でモデルリストを更新
8. チャット画面に戻る
9. モデルセレクターから"gpt-4o"を選択
10. アプリケーションを再起動
11. チャット画面で"gpt-4o"が自動選択されていることを確認（localStorage復元）

**シナリオ2: 自動圧縮とメッセージ永続化**
1. チャット画面で50メッセージを送信（トークン数が制限の85%に達するまで）
2. 次のメッセージを送信
3. 送信前に自動圧縮が実行されることをログで確認
4. 古いメッセージが要約されてシステムメッセージに変換されることを確認
5. 最新10メッセージが保持されることを確認
6. データベースにユーザーメッセージとAI応答が保存されていることを確認（sqlite3コマンドで検証）

**シナリオ3: セッション履歴の復元と圧縮マーカー**
1. シナリオ2の圧縮済みセッションを選択
2. チャット履歴が完全に復元されることを確認
3. 圧縮マーカーが適切な位置に表示されることを確認
4. 圧縮マーカーに要約内容、圧縮日時、メッセージ数が表示されることを確認
5. 新しいメッセージを送信
6. 圧縮マーカーがAIに送信されないことをログで確認

**シナリオ4: ストリーミングの中断**
1. チャット画面で長い応答を生成するメッセージを送信（例: 「1000語のエッセイを書いて」）
2. ストリーミング開始後、3秒待つ
3. 停止ボタンをクリック
4. ストリーミングが即座に停止することを確認
5. 中断時点までの部分応答が表示されることを確認
6. 部分応答がデータベースに保存されていることを確認
7. 入力フィールドが再有効化されることを確認

**シナリオ5: エラー時のメッセージ復元と再送信**
1. プロバイダー設定のAPIキーを無効な値に変更
2. チャット画面で「こんにちは」とメッセージを送信
3. 認証エラーメッセージが表示されることを確認
4. 入力フィールドに「こんにちは」が自動復元されることを確認
5. 「詳細を表示」ボタンをクリック
6. HTTPステータスコード401、推奨対処法（API キー確認）が表示されることを確認
7. 設定画面でAPIキーを修正
8. チャット画面に戻る
9. 復元された「こんにちは」をそのまま送信ボタンで再送信
10. 正常に送信され、AI応答が表示されることを確認

### 14.2 検証基準

- チャット使用前の検証が全ての状態（設定なし、モデルなし、モデル未選択）を適切に検出する
- モデル選択がlocalStorageに保存され、次回起動時に正しく復元される
- 自動圧縮がトークン制限の80%で確実に実行される
- 全てのメッセージ（ユーザー、AI、ツール呼び出し）がデータベースに保存される
- セッション履歴が完全に復元され、圧縮マーカーが正しい位置に表示される
- ストリーミングが中断された場合でも部分応答が保存される
- エラーが発生した場合、メッセージが失われず、再送信が容易である
- エラーが適切に分類され、詳細情報と推奨対処法が表示される

---

## 15. 非機能要件

### 15.1 パフォーマンス

**NFR-1: ストリーミング応答の低遅延**

The システム shall AIから受信した最初のトークンを100ms以内にユーザーに表示する

**NFR-2: UI応答性の維持**

While システムがストリーミング応答を処理している, the システム shall UIの応答性を維持し、ユーザーの操作を受け付ける

**NFR-3: 履歴読み込みの高速化**

The システム shall セッション履歴（最大500メッセージ）を1秒以内に読み込み表示する

### 15.2 セキュリティ

**NFR-4: APIキーの非表示**

The システム shall ログファイルやエラーメッセージにAPIキーを含めない

**NFR-5: ツール実行の透明性**

The システム shall AIによる全てのツール実行をユーザーに可視化する

### 15.3 データ整合性

**NFR-6: メッセージの原子性**

The システム shall メッセージ保存操作をアトミックに実行し、部分的な保存を防止する

**NFR-7: ストリーミング中断時のデータ保護**

If ストリーミングが中断された, the システム shall 中断時点までのデータを確実に保存する

### 15.4 ユーザビリティ

**NFR-8: エラーメッセージの明確性**

The システム shall エラーメッセージに問題の原因と推奨される対処法を含める

**NFR-9: 長文応答の可読性**

The システム shall 長文のAI応答に対してもスムーズなスクロールと読みやすいレイアウトを提供する

**NFR-10: メッセージの非破壊性**

The システム shall エラー発生時もユーザーが入力した内容を失わない

---

## 16. 関連文書

- [要件定義概要](./REQUIREMENTS_OVERVIEW.md)
- [MCP統合設計](./MCP_INTEGRATION_DESIGN.md)
- [チャットエラーハンドリング設計](./CHAT_ERROR_HANDLING_DESIGN.md)
- [会話履歴圧縮設計](./CONVERSATION_HISTORY_COMPRESSION_DESIGN.md)
- [チャットセッション永続化設計](./CHAT_SESSION_PERSISTENCE.md)
- [ツール表示実装](./TOOL_DISPLAY_IMPLEMENTATION.md)

---

## 17. 実装ファイル参照

以下のファイルが本要件の実装を担当しています（参考情報）：

- `src/renderer/src/components/ChatPage.tsx` (要件1-9: チャット使用前の検証)
- `src/renderer/src/components/AIRuntimeProvider.tsx` (要件29-44, 58-66, 82-83: 自動圧縮、メッセージ永続化、履歴復元)
- `src/renderer/src/lib/ai.ts` (要件52-54, 67-75: ストリーミングイベント処理、中断)
- `src/backend/ai/stream.ts` (要件84-97: ツール呼び出し、ログ記録)
- `src/renderer/src/lib/message-converter.ts` (要件76-78: 圧縮マーカー生成)

---

**作成者メモ**: 本文書（v2.0）は実装済み機能に基づいて全面改訂されました。要件数を58から115に拡充し、13個のユースケースをカバーしています。全ての要件はEARSフォーマットに従い、テスト可能な形式で記述されています。
