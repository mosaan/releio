# AIプロバイダー管理要件

## ドキュメント情報

- **作成日**: 2025-11-18
- **バージョン**: 1.0
- **対象ユースケース**: UC-PROV-01 〜 UC-PROV-05
- **関連設計**: [AI設定V2設計](./AI_SETTINGS_V2_DESIGN.md)

## 1. UC-PROV-01: AIプロバイダー設定を追加する

### 1.1 ユースケース概要

ユーザーが新しいAIプロバイダー（OpenAI、Anthropic、Google、Azure OpenAI）の接続設定を追加します。同じプロバイダータイプの複数設定（例: 公式OpenAIとローカルOpenAI互換サーバー）をサポートします。

### 1.2 事前条件

- The システム shall 設定画面が表示されている

### 1.3 事後条件

- The システム shall 新しいプロバイダー設定がデータベースに保存されている
- The システム shall プロバイダー設定一覧に新しい設定が表示されている

### 1.4 要件

#### 1.4.1 設定入力

**1. 必須フィールドの提供**

The システム shall 以下の必須フィールドを提供する：
- 設定名（ユーザーが識別しやすい名前）
- プロバイダータイプ（OpenAI、Anthropic、Google、Azure OpenAI）
- APIキー

**2. オプションフィールドの提供**

The システム shall 以下のオプションフィールドを提供する：
- Base URL（OpenAI互換APIサーバー用）
- リソース名（Azure専用）
- デプロイメントベースURL使用フラグ（Azure専用）

**3. プロバイダータイプ別のフィールド表示**

When ユーザーがAzure OpenAIをプロバイダータイプとして選択した, the システム shall Azure固有のフィールド（リソース名、デプロイメントベースURL）を表示する

When ユーザーがAzure以外のプロバイダータイプを選択した, the システム shall Azure固有のフィールドを非表示にする

#### 1.4.2 バリデーション

**4. 必須フィールドの検証**

If ユーザーが必須フィールド（設定名、APIキー）を空欄のまま保存を試みた, the システム shall エラーメッセージを表示し保存を拒否する

**5. 設定名の一意性検証**

If ユーザーが既存の設定名と重複する名前を入力した, the システム shall 警告メッセージを表示し、同名の設定が既に存在することを通知する

**6. Base URLの形式検証**

If ユーザーがBase URLに無効なURL形式を入力した, the システム shall エラーメッセージを表示し、正しいURL形式（http://またはhttps://で始まる）を要求する

#### 1.4.3 設定保存

**7. UUID自動生成**

When ユーザーが新しいプロバイダー設定を保存した, the システム shall ユニークなUUID識別子を自動生成し、設定に割り当てる

**8. タイムスタンプ自動記録**

When ユーザーが新しいプロバイダー設定を保存した, the システム shall 作成日時（createdAt）と更新日時（updatedAt）を現在時刻で記録する

**9. デフォルトモデルの設定**

When ユーザーが新しいプロバイダー設定を保存した, the システム shall プロバイダータイプに応じたデフォルトモデルリストを自動的に設定に含める

**10. 有効状態の設定**

When ユーザーが新しいプロバイダー設定を保存した, the システム shall 設定をデフォルトで有効（enabled: true）状態で保存する

#### 1.4.4 ユーザーフィードバック

**11. 保存成功の通知**

When プロバイダー設定が正常に保存された, the システム shall 成功メッセージを表示し、設定一覧画面に遷移する

**12. 保存失敗の通知**

If プロバイダー設定の保存中にエラーが発生した, the システム shall エラーメッセージを表示し、ユーザーが修正できるようダイアログを開いたままにする

---

## 2. UC-PROV-02: AIプロバイダー設定を編集する

### 2.1 ユースケース概要

ユーザーが既存のAIプロバイダー設定（APIキー、Base URL等）を変更します。

### 2.2 事前条件

- The システム shall 少なくとも1つのプロバイダー設定が存在する

### 2.3 事後条件

- The システム shall 変更されたプロバイダー設定がデータベースに保存されている
- The システム shall 更新日時（updatedAt）が更新されている

### 2.4 要件

#### 2.4.1 編集開始

**13. 編集ダイアログの表示**

When ユーザーがプロバイダー設定の「編集」ボタンをクリックした, the システム shall 現在の設定内容が入力済みの編集ダイアログを表示する

**14. プロバイダータイプの読み取り専用化**

While ユーザーが既存の設定を編集している, the システム shall プロバイダータイプフィールドを読み取り専用（変更不可）として表示する

#### 2.4.2 変更の反映

**15. APIキー変更時のテスト推奨**

When ユーザーがAPIキーを変更した, the システム shall 「接続テスト」ボタンを強調表示し、変更後のテストを促す

**16. Base URL変更時の警告**

When ユーザーがBase URLを変更した, the システム shall 既存のモデルリストが新しいエンドポイントと互換性がない可能性があることを警告する

**17. 更新日時の自動記録**

When ユーザーが設定の変更を保存した, the システム shall 更新日時（updatedAt）を現在時刻で更新する

#### 2.4.3 デフォルト選択の保護

**18. デフォルト選択の維持**

When ユーザーが現在デフォルト選択中のプロバイダー設定を編集した, the システム shall デフォルト選択を維持する（設定IDは変更しない）

**19. モデルIDの変更検出**

If ユーザーが編集によりデフォルト選択中のモデルIDを削除した, the システム shall デフォルト選択をクリアし、ユーザーに再選択を促す

---

## 3. UC-PROV-03: AIプロバイダー設定を削除する

### 3.1 ユースケース概要

ユーザーが不要になったプロバイダー設定を削除します。

### 3.2 事前条件

- The システム shall 少なくとも1つのプロバイダー設定が存在する

### 3.3 事後条件

- The システム shall 指定されたプロバイダー設定がデータベースから削除されている
- The システム shall 設定一覧から削除された設定が表示されていない

### 3.4 要件

#### 3.4.1 削除確認

**20. 削除前の確認ダイアログ**

When ユーザーがプロバイダー設定の「削除」ボタンをクリックした, the システム shall 削除確認ダイアログを表示し、設定名を含む警告メッセージを表示する

**21. デフォルト選択中の設定削除警告**

If ユーザーが現在デフォルト選択中のプロバイダー設定を削除しようとした, the システム shall 追加の警告メッセージを表示し、削除後は別の設定を選択する必要があることを通知する

#### 3.4.2 削除処理

**22. 設定の完全削除**

When ユーザーが削除を確認した, the システム shall プロバイダー設定とそれに紐づく全てのモデル定義をデータベースから削除する

**23. デフォルト選択のクリア**

When ユーザーがデフォルト選択中のプロバイダー設定を削除した, the システム shall デフォルト選択（defaultSelection）をクリアする

#### 3.4.3 削除の制約

**24. 有効な設定の削除防止**

If ユーザーが有効状態（enabled: true）のプロバイダー設定を削除しようとした, the システム shall 削除を拒否し、先に無効化するよう要求するエラーメッセージを表示する

---

## 4. UC-PROV-04: モデルリストを更新する

### 4.1 ユースケース概要

ユーザーがプロバイダーのAPIから最新のモデル一覧を取得し、設定に反映します。

### 4.2 事前条件

- The システム shall プロバイダー設定が存在し、有効なAPIキーが設定されている

### 4.3 事後条件

- The システム shall 最新のモデルリストが設定に保存されている
- The システム shall モデル最終更新日時（modelLastRefreshed）が更新されている

### 4.4 要件

#### 4.4.1 更新開始

**25. 更新ボタンの提供**

The システム shall 各プロバイダー設定に「モデルリストを更新」ボタンを提供する

**26. 更新中の視覚的フィードバック**

While システムがAPIからモデルリストを取得している, the システム shall ローディングインジケーターを表示し、ボタンを無効化する

#### 4.4.2 API呼び出し

**27. OpenAIモデル一覧の取得**

When ユーザーがOpenAI設定のモデルリスト更新を実行した, the システム shall `/v1/models`エンドポイントにリクエストを送信し、利用可能なモデルIDのリストを取得する

**28. Azureモデル一覧の取得**

When ユーザーがAzure OpenAI設定のモデルリスト更新を実行した, the システム shall Azure固有のエンドポイント（デプロイメント一覧）から利用可能なモデルIDを取得する

**29. Anthropicモデル一覧のフォールバック**

When ユーザーがAnthropic設定のモデルリスト更新を実行した, the システム shall APIにモデル一覧エンドポイントが存在しないため、既存のモデルリストを保持する

**30. Googleモデル一覧のフォールバック**

When ユーザーがGoogle設定のモデルリスト更新を実行した, the システム shall APIにシンプルなモデル一覧エンドポイントが存在しないため、既存のモデルリストを保持する

#### 4.4.3 モデルリストの更新

**31. APIソースモデルの完全置換**

When システムがAPIから新しいモデルリストを取得した, the システム shall 既存のAPIソース（source: 'api'）モデルを全て削除し、新しいAPIレスポンスのモデルで置き換える

**32. カスタムモデルの保護**

When システムがAPIからモデルリストを更新した, the システム shall カスタムソース（source: 'custom'）のモデルを削除せず保持する

**33. 更新日時の記録**

When モデルリストの更新が完了した, the システム shall modelLastRefreshedフィールドを現在時刻で更新する

#### 4.4.4 エラーハンドリング

**34. API接続エラーの処理**

If モデルリスト更新中にAPI接続エラーが発生した, the システム shall エラーメッセージを表示し、既存のモデルリストを保持する

**35. 認証エラーの処理**

If モデルリスト更新中に認証エラー（401、403）が発生した, the システム shall APIキーが無効である可能性を示すエラーメッセージを表示する

**36. 非推奨モデルの自動削除**

When システムがAPIから新しいモデルリストを取得した, the システム shall 新しいAPIレスポンスに含まれないモデルIDは自動的に削除される（非推奨モデルの自然な削除）

---

## 5. UC-PROV-05: カスタムモデルを追加する

### 5.1 ユースケース概要

ユーザーがAPI経由で取得できないカスタムモデル（ファインチューニングモデル、プライベートモデル等）を手動で追加します。

### 5.2 事前条件

- The システム shall プロバイダー設定が存在する

### 5.3 事後条件

- The システム shall カスタムモデルがプロバイダー設定のモデルリストに追加されている

### 5.4 要件

#### 5.4.1 モデル追加

**37. カスタムモデル追加ボタンの提供**

The システム shall 各プロバイダー設定の編集ダイアログに「カスタムモデルを追加」ボタンを提供する

**38. モデルID入力フィールド**

When ユーザーがカスタムモデル追加ボタンをクリックした, the システム shall モデルID（必須）と表示名（オプション）の入力フィールドを表示する

#### 5.4.2 バリデーション

**39. モデルIDの必須検証**

If ユーザーがモデルIDを空欄のまま保存を試みた, the システム shall エラーメッセージを表示し、モデルIDが必須であることを通知する

**40. モデルIDの重複検証**

If ユーザーが既に設定に存在するモデルIDを入力した, the システム shall エラーメッセージを表示し、モデルIDが重複していることを通知する

**41. モデルIDの形式検証**

If ユーザーが無効な文字（スペース、特殊記号）を含むモデルIDを入力した, the システム shall 警告メッセージを表示し、プロバイダーが受け付けない可能性があることを通知する

#### 5.4.3 モデル保存

**42. カスタムソースタグの付与**

When ユーザーがカスタムモデルを保存した, the システム shall モデルのsourceフィールドを'custom'に設定する

**43. 追加日時の記録**

When ユーザーがカスタムモデルを保存した, the システム shall addedAtフィールドを現在時刻で記録する

**44. カスタムモデルの表示**

When カスタムモデルが保存された, the システム shall モデルリストにカスタムモデルを表示し、ソースインジケーター（"Custom"バッジ）を付与する

#### 5.4.4 カスタムモデルの削除

**45. カスタムモデル削除の許可**

The システム shall カスタムソース（source: 'custom'）のモデルのみ削除を許可する

**46. APIソースモデル削除の禁止**

If ユーザーがAPIソース（source: 'api'）のモデルを削除しようとした, the システム shall 削除を拒否し、モデルリスト更新機能を使用するよう案内する

**47. カスタムモデル削除時の確認**

When ユーザーがカスタムモデルの削除ボタンをクリックした, the システム shall 確認ダイアログを表示し、モデルIDを含む警告メッセージを表示する

---

## 6. テスト可能性

### 6.1 受け入れテストシナリオ

**シナリオ1: 複数の同一タイプ設定を追加**
1. OpenAI公式設定を追加（名前: "OpenAI Official"、APIキー: sk-xxx）
2. OpenAI互換設定を追加（名前: "LocalLM"、Base URL: http://localhost:8000）
3. 設定一覧に両方が表示されることを確認
4. 各設定が異なるUUIDを持つことを確認

**シナリオ2: モデルリストの更新と保護**
1. OpenAI設定にカスタムモデル "my-fine-tuned-gpt-4"を追加
2. モデルリスト更新を実行
3. APIから取得したモデルが反映されることを確認
4. カスタムモデル "my-fine-tuned-gpt-4"が削除されていないことを確認

**シナリオ3: デフォルト選択の保護**
1. プロバイダー設定Aのモデル "gpt-4o"をデフォルト選択に設定
2. プロバイダー設定Aを編集し、モデル "gpt-4o"を削除
3. デフォルト選択がクリアされることを確認
4. チャット画面でモデル選択が必要になることを確認

### 6.2 検証基準

- 全てのバリデーションエラーがユーザーに明確に通知される
- データベースに保存されたデータが型定義（AIProviderConfiguration、AIModelDefinition）に適合する
- API呼び出しが失敗しても既存データが破壊されない
- ユーザーの操作に対して適切な視覚的フィードバックが提供される

---

## 7. 関連文書

- [要件定義概要](./REQUIREMENTS_OVERVIEW.md)
- [AI設定V2設計](./AI_SETTINGS_V2_DESIGN.md)
- [型定義](../src/common/types.ts)

---

**作成者メモ**: 本文書はEARSフォーマットに従い、テスト可能な要件として記述されています。実装の詳細（UIコンポーネント名、ファイルパス等）は含めず、「何をするか」に焦点を当てています。
