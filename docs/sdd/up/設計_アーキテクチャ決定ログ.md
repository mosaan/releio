# アーキテクチャ決定ログ（設計観点・方向づけ版）

設計ワークフローで扱う主要なアーキテクチャ決定を記録するログです。方向づけフェーズでは、既に暗黙に選択されている設計を明文化し、推敲フェーズ以降で精査・更新するための出発点を残します。

- **Status**: Accepted（採択済み）、Proposed（検討中）、Deferred（保留）
- **Rationale/Consequences**は簡潔に記載し、詳細は関連ドキュメントを参照できるようにする。
- 変更時は必ず本ファイルを更新し、日付と筆者を残す。

## 決定一覧

| ID | Status | 日付 | 決定 | Rationale | Consequences/メモ |
|----|--------|------|------|-----------|-------------------|
| AD-001 | Accepted | 2025-11-25 | Backendを`utilityProcess`としてMainからforkし、RendererとはMessagePortでIPCする | UIクラッシュ隔離と型付きIPC集中管理を両立するため | Mainがポート配布を担い、断時の再配布戦略が必要 |
| AD-002 | Accepted | 2025-11-25 | AIストリーミングはBackendの`AIStreamService`で単一路線に集約し、Rendererへイベントストリームを送る | ツール呼び出し/トークンを一貫したフォーマットで扱い、再送/中断を制御しやすくする | Rendererは表示専念、AI接続失敗時のリトライ/エラー提示はBackendが司る |
| AD-003 | Accepted | 2025-11-25 | MCPサーバーはstdio子プロセスとしてBackendが起動・監視する | MCP標準実装に沿い、AIストリームと同一プロセスでツール定義を統合するため | サーバー多重起動時のリソース管理・障害切り分けが課題 |
| AD-004 | Accepted | 2025-11-25 | 会話履歴圧縮は`CompressionService`がTokenCounter+要約でスナップショットを生成し、`ChatSessionStore`へ保存する | 長文セッションでのコンテキスト肥大を抑え、AIコストを制御するため | 閾値/保持戦略を設定化し、UIで可視化する必要がある |
| AD-005 | Accepted | 2025-11-25 | 自動更新は`electron-updater`による静的HTTPS配布（Windows NSIS）を採用 | 署名検証込みの標準実装でリスクを抑えるため | Updateサーバー設定は`updater.json`または環境変数を使用。macOS/Linuxは将来対応 |
| AD-006 | Accepted | 2025-11-25 | プロキシ/証明書設定はBackend設定層で一元管理し、AI/MCP/更新経路に適用する | 企業ネットワーク対応とトラブルシューティング容易化のため | 設定変更後の接続テストAPIを提供する。証明書配置の手順は要追記 |
| AD-007 | Proposed | 2025-11-25 | MessagePort断時の再配布をMainが主導し、Renderer/Backendの片方が落ちても再接続できる仕組みを導入する | 長時間稼働時の信頼性向上を狙う | プロトコル・再接続通知の設計が未定 |
| AD-008 | Proposed | 2025-11-25 | 圧縮閾値/保持ポリシーをユーザー設定可能にし、セッション別に上書きできるようにする | 多様なモデル/トークン制限に対応するため | UI/設定スキーマ変更とマイグレーションが必要 |
| AD-009 | Proposed | 2025-11-25 | MCPサーバーの並列起動数に上限を設け、リソース監視を行う | 開発者PCでのリソース逼迫防止 | 上限超過時のUI警告とキューイング/拒否ポリシーを決める必要 |

## 追跡方法と更新ルール
- 新規決定や変更が生じた場合は、IDを採番しStatus/日付/筆者を記録する。
- 決定の結果がコードに反映されたら、関連ファイル（パス・主要クラス）をメモする。
- 廃止された決定はStatusを`Superseded`に変更し、代替IDを明記する（今後追加予定）。

## 関連資料
- `docs_UP/分析_ソフトウェアアーキテクチャ記述.md`（4+1ビュー）
- `docs_UP/分析_ユースケース実現.md`（主要ユースケースの流れ）
- `docs/MCP_INTEGRATION_DESIGN.md`, `docs/PROXY_AND_CERTIFICATE_DESIGN.md`, `docs/AUTO_UPDATE.md`（既存詳細設計）
