# 非機能要求

本ドキュメントでは、Releio の非機能要求（性能・セキュリティ・可用性・保守性等）を定義する。

- **対象読者**: アーキテクト、開発チーム、インフラ担当
- **目的**: システム品質特性の明確化、設計制約の共有
- **関連**: `requirements/acceptance-criteria.md`, `architecture/overview.md`

---

## 1. 性能要求（Performance）

### 1.1 応答時間

| 項目                  | 目標値 | 最大許容値 | 測定条件                               |
| --------------------- | ------ | ---------- | -------------------------------------- |
| AI ストリーミング開始 | 0.3秒  | 0.5秒      | ユーザー送信後、最初のチャンク受信まで |
| セッション切り替え    | 300ms  | 500ms      | 100メッセージ以下のセッション          |
| 設定画面ロード        | 100ms  | 200ms      | 初回レンダリング完了まで               |
| DB クエリ（単一取得） | 5ms    | 10ms       | `getSession(id)` 実行時間              |
| DB クエリ（一覧取得） | 50ms   | 100ms      | 1000セッション取得                     |

### 1.2 スループット

| 項目                      | 目標値      | 条件                             |
| ------------------------- | ----------- | -------------------------------- |
| AI ストリーミング同時実行 | 1セッション | 単一ユーザーアプリのため並列不要 |
| DB 書き込み頻度           | 10 qps      | メッセージ保存・設定更新         |
| MCP ツール同時実行        | 5ツール     | AI が複数ツールを並列呼び出し    |

### 1.3 リソース使用量

| リソース           | 目標値             | 最大許容値 | 測定条件                       |
| ------------------ | ------------------ | ---------- | ------------------------------ |
| メモリ（アイドル） | 200MB              | 300MB      | Main + Backend + Renderer 合計 |
| メモリ（稼働中）   | 400MB              | 500MB      | AI ストリーミング実行中        |
| メモリ（長時間）   | 500MB              | 1GB        | 8時間稼働後                    |
| CPU（アイドル）    | <5%                | 10%        | ユーザー操作なし               |
| CPU（AI実行中）    | <30%               | 50%        | ストリーミング応答受信中       |
| ディスク使用量     | 50MB               | 100MB      | アプリ本体（DB除く）           |
| DB サイズ          | 10MB/100セッション | 1GB        | 圧縮機能で制御                 |

---

## 2. セキュリティ要求（Security）

### 2.1 認証・認可

| 要求               | 実装方法                                              |
| ------------------ | ----------------------------------------------------- |
| API キー保護       | Electron `safeStorage` で暗号化保存                   |
| ローカルデータ保護 | DB ファイルは OS ユーザー権限で保護（chmod 600）      |
| プロセス間通信     | MessagePort で IPC 通信、外部プロセスからアクセス不可 |

### 2.2 データ保護

| データ種別       | 保護方法                 | 格納場所                 |
| ---------------- | ------------------------ | ------------------------ |
| API キー         | 暗号化保存               | `settings` テーブル      |
| プロキシ認証情報 | 暗号化保存               | `settings` テーブル      |
| 会話履歴         | 平文保存（ローカルのみ） | `chat_messages` テーブル |
| 証明書ファイル   | OS ファイルシステム権限  | ユーザー指定パス         |

### 2.3 通信セキュリティ

| 要求         | 実装                                      |
| ------------ | ----------------------------------------- |
| HTTPS 強制   | AI API 呼び出しは HTTPS のみ許可          |
| 証明書検証   | デフォルト有効、カスタム証明書対応        |
| プロキシ対応 | HTTP/HTTPS プロキシ経由での通信           |
| タイムアウト | 全ネットワーク呼び出しに 30秒タイムアウト |

### 2.4 ツール実行制御（HITL）

| 要求               | 実装                                        |
| ------------------ | ------------------------------------------- |
| デフォルト承認必須 | 初回ツール実行時は必ず承認ダイアログ        |
| 権限ルール管理     | `tool_permission_rules` で自動承認/拒否設定 |
| 監査ログ           | 全ツール実行（承認/拒否）をログ記録         |

---

## 3. 可用性要求（Availability）

### 3.1 稼働時間

| 項目               | 目標値                | 備考                      |
| ------------------ | --------------------- | ------------------------- |
| アプリ稼働率       | 99.9%（ローカル実行） | クラッシュ・フリーズなし  |
| Backend 可用性     | 99.9%                 | Main プロセスが自動再起動 |
| MCP サーバー可用性 | ベストエフォート      | クラッシュ時は手動再起動  |

### 3.2 耐障害性

| 障害シナリオ           | 復旧方法                            | 復旧時間     |
| ---------------------- | ----------------------------------- | ------------ |
| Backend クラッシュ     | Main が検出 → 自動再起動            | 5秒以内      |
| AI API エラー          | 3回リトライ（指数バックオフ）       | 15秒以内     |
| MCP サーバークラッシュ | ステータス表示 + 手動再起動ボタン   | ユーザー操作 |
| DB ロック              | 5秒待機 → リトライ                  | 10秒以内     |
| ディスク容量不足       | エラー通知 + 古いセッション削除提案 | ユーザー操作 |

### 3.3 データ永続性

| 要求                 | 実装                                                               |
| -------------------- | ------------------------------------------------------------------ |
| メッセージ保存保証   | AI 応答完了後、即座に DB コミット                                  |
| トランザクション保証 | 複数テーブル更新は Drizzle トランザクション                        |
| バックアップ         | ユーザーが手動で DB ファイルをコピー（自動バックアップは Phase 2） |

---

## 4. 保守性要求（Maintainability）

### 4.1 コード品質

| 項目                  | 目標値      | 検証方法                 |
| --------------------- | ----------- | ------------------------ |
| TypeScript カバレッジ | 100%        | すべてのファイルで型定義 |
| ESLint 違反           | 0件         | CI で自動チェック        |
| Unit Test カバレッジ  | 80% 以上    | Backend ロジック         |
| 循環的複雑度          | 10以下/関数 | ESLint complexity ルール |

### 4.2 ログ・監視

| 要求               | 実装                                          |
| ------------------ | --------------------------------------------- |
| 構造化ログ         | `logger.info('[Context]', {key: value})` 形式 |
| ログレベル         | info / warn / error の 3段階                  |
| ログローテーション | electron-log が自動実施（1MB/ファイル）       |
| クラッシュレポート | electron-log の errorHandler で捕捉           |

### 4.3 ドキュメント

| ドキュメント種別        | 対象読者       | 更新頻度     |
| ----------------------- | -------------- | ------------ |
| SDD（本ドキュメント群） | 開発者         | 設計変更時   |
| README.md               | エンドユーザー | リリース時   |
| API ドキュメント        | 開発者         | コード変更時 |
| ADR（設計判断記録）     | アーキテクト   | 重要判断時   |

---

## 5. 移植性要求（Portability）

### 5.1 プラットフォーム対応

| OS                    | サポートレベル | 検証方法        |
| --------------------- | -------------- | --------------- |
| Windows 10/11 (64bit) | フルサポート   | 実機テスト + CI |
| macOS 12+             | フルサポート   | 実機テスト + CI |
| Linux (Ubuntu 20.04+) | 参考サポート   | CI のみ         |

### 5.2 データ互換性

| 項目                  | 要求                           |
| --------------------- | ------------------------------ |
| DB スキーマバージョン | Drizzle マイグレーションで管理 |
| 設定ファイル形式      | JSON（バージョン番号付き）     |
| エクスポート形式      | JSON / CSV / Markdown          |

---

## 6. スケーラビリティ要求（Scalability）

### 6.1 データ量

| 項目                    | 最小保証 | 推奨上限 | 備考                       |
| ----------------------- | -------- | -------- | -------------------------- |
| セッション数            | 1,000    | 10,000   | 圧縮機能で削減             |
| メッセージ数/セッション | 100      | 1,000    | 圧縮で要約                 |
| MCP サーバー数          | 5        | 20       | 多すぎるとツール一覧が煩雑 |
| AI プロバイダー数       | 3        | 10       | UI で切り替え可能          |

### 6.2 同時実行

| 項目              | 制限        | 理由                  |
| ----------------- | ----------- | --------------------- |
| AI ストリーミング | 1セッション | 単一ユーザーアプリ    |
| MCP ツール実行    | 5並列       | AI が並列呼び出し可能 |
| DB 接続           | 1接続       | SQLite は単一書き込み |

---

## 7. 使いやすさ要求（Usability）

### 7.1 学習容易性

| 要求               | 実装                              |
| ------------------ | --------------------------------- |
| 初回セットアップ   | 5分以内で完了（API キー入力のみ） |
| ウィザード形式     | 初回起動時に表示（Phase 2）       |
| ヘルプドキュメント | README + オンラインドキュメント   |

### 7.2 アクセシビリティ

| 要求               | 基準                         |
| ------------------ | ---------------------------- |
| キーボード操作     | 全機能をマウスなしで操作可能 |
| フォーカス表示     | アウトライン明確表示         |
| コントラスト比     | WCAG AA（4.5:1）             |
| スクリーンリーダー | 主要機能で対応（aria-label） |

### 7.3 エラーハンドリング

| 要求                 | 実装                                |
| -------------------- | ----------------------------------- |
| エラーメッセージ形式 | 「何が起きたか + どうすればよいか」 |
| ユーザーフレンドリー | 技術用語を排除、平易な表現          |
| エラー回復           | 可能な限り自動リトライ              |

---

## 8. 互換性要求（Compatibility）

### 8.1 AI プロバイダー

| プロバイダー | サポートバージョン | 備考                   |
| ------------ | ------------------ | ---------------------- |
| OpenAI       | API v1             | GPT-4o, GPT-4, GPT-3.5 |
| Anthropic    | API 2024-01-01     | Claude 3.5, Claude 3   |
| Google       | Gemini API v1      | Gemini 1.5 Pro/Flash   |
| Azure OpenAI | API 2024-02-01     | Phase 2                |

### 8.2 MCP プロトコル

| 項目           | サポート                  |
| -------------- | ------------------------- |
| MCP バージョン | 1.0                       |
| トランスポート | stdio, SSE                |
| 機能           | Tools, Resources, Prompts |

### 8.3 Electron

| 項目     | バージョン |
| -------- | ---------- |
| Electron | 37.x       |
| Chromium | 130.x      |
| Node.js  | 20.x       |

---

## 9. 法規制・コンプライアンス

### 9.1 ライセンス

| 項目                    | 内容                                   |
| ----------------------- | -------------------------------------- |
| アプリライセンス        | MIT License                            |
| 依存ライブラリ          | MIT / Apache 2.0 / BSD（商用利用可能） |
| AI プロバイダー利用規約 | ユーザー自身が各プロバイダーと契約     |

### 9.2 データプライバシー

| 要求           | 実装                                            |
| -------------- | ----------------------------------------------- |
| データ保存場所 | ローカルのみ（クラウド送信なし）                |
| ユーザー同意   | 初回起動時にプライバシーポリシー表示（Phase 2） |
| データ削除     | ユーザーがセッション削除可能                    |

---

## 10. 開発・デプロイ要求

### 10.1 ビルド要求

| 項目             | 要求                                             |
| ---------------- | ------------------------------------------------ |
| ビルド時間       | 5分以内（開発ビルド）                            |
| パッケージサイズ | 150MB 以下（インストーラー）                     |
| コード署名       | Windows: Authenticode, macOS: Apple Developer ID |

### 10.2 CI/CD

| 項目                | 実装                                      |
| ------------------- | ----------------------------------------- |
| CI プラットフォーム | GitHub Actions                            |
| テスト実行          | 全 PR で自動実行                          |
| ビルド成果物        | Windows .exe, macOS .dmg, Linux .AppImage |
| リリース配布        | GitHub Releases                           |

### 10.3 更新配布

| 項目         | 実装                    |
| ------------ | ----------------------- |
| 自動更新     | electron-updater 経由   |
| 更新確認頻度 | アプリ起動時（3秒遅延） |
| 更新チャネル | latest / beta           |

---

## まとめ

本非機能要求は、Releio の品質目標を定義する。各要求は受入基準と連動し、リリース判定の基準となる。

**優先順位**:

1. **性能・セキュリティ・可用性**: MVP必須
2. **保守性・使いやすさ**: 初期リリース推奨
3. **移植性・スケーラビリティ**: Phase 2以降

**次のステップ**:

- 各要求を設計・実装に反映
- テスト計画で検証項目を具体化
- リリース前に全要求を確認
