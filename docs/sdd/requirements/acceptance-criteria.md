# 横断受入基準

本ドキュメントでは、個別のユーザーストーリーに依存しない、システム全体に適用される受入基準を定義する。

- **対象読者**: QA、開発チーム、プロダクトマネージャー
- **目的**: 品質基準の統一、テスト設計の基盤、リリース判定基準
- **関連**: `requirements/user-stories.md`, `requirements/non-functional.md`

---

## 1. 性能（Performance）

### 1.1 応答速度

| 項目                          | 基準                                                                | 測定方法                                                             |
| ----------------------------- | ------------------------------------------------------------------- | -------------------------------------------------------------------- |
| **AI ストリーミング開始時間** | ユーザー送信後 **0.5秒以内** に最初のチャンクを受信                 | Backend → Renderer 間の `mastraChatChunk` イベント初回タイムスタンプ |
| **UI 応答性**                 | ボタンクリック → UI 反映まで **100ms 以内**                         | React DevTools Profiler で Commit 時間計測                           |
| **セッション切り替え**        | セッション選択 → メッセージ履歴表示まで **500ms 以内**（100件まで） | `getChatSession()` API 呼び出し～UI レンダリング完了                 |
| **設定画面ロード**            | 設定タブ切り替え → 表示まで **200ms 以内**                          | ページ遷移イベント～初回レンダリング                                 |

**検証方法**:

- Chrome DevTools Performance タブでタイムライン計測
- Backend ログで API 処理時間記録（`logger.info` で開始/終了タイムスタンプ）
- 自動テスト: Vitest + `performance.now()` でベンチマーク

**不合格時の対処**:

- 性能ボトルネックを特定（DB クエリ・IPC 通信・レンダリング）
- 最適化実装（インデックス追加・仮想化・メモ化）
- 最適化後も基準未達の場合、要求緩和を検討

---

### 1.2 メモリ使用量

| 項目                 | 基準                                             | 測定方法                                      |
| -------------------- | ------------------------------------------------ | --------------------------------------------- |
| **アイドル時メモリ** | Main + Backend + Renderer 合計 **300MB 以下**    | Electron Task Manager / OS タスクマネージャー |
| **長時間稼働後**     | 8時間稼働後も **500MB 以下**（メモリリーク防止） | `process.memoryUsage()` を定期記録            |
| **大量セッション時** | 100セッション + 各100メッセージで **1GB 以下**   | 負荷テストで計測                              |

**検証方法**:

- Electron DevTools Memory Profiler でヒープスナップショット取得
- 長時間稼働テスト（CI で 8時間自動実行）
- メモリリーク検出: `heapdump` ライブラリで定期ダンプ

**不合格時の対処**:

- メモリリーク箇所を特定（イベントリスナー未解除・循環参照）
- `useEffect` cleanup 関数で適切に破棄
- 大量データ時は仮想スクロール（react-window）適用

---

### 1.3 データベース性能

| 項目                   | 基準                                    | 測定方法                                 |
| ---------------------- | --------------------------------------- | ---------------------------------------- |
| **メッセージ挿入**     | 1件挿入 **10ms 以内**                   | `ChatSessionStore.addMessage()` 実行時間 |
| **セッション一覧取得** | 1000セッション取得 **100ms 以内**       | `listSessions()` 実行時間                |
| **全文検索**           | 10,000メッセージから検索 **500ms 以内** | `searchSessions(query)` 実行時間         |

**検証方法**:

- Backend ログで DB クエリ時間記録
- Drizzle ORM の `.$debug()` でクエリ実行計画確認
- SQLite EXPLAIN QUERY PLAN で最適化検証

**不合格時の対処**:

- インデックス追加（`session_id`, `created_at`, FTS5 仮想テーブル）
- クエリ最適化（不要な JOIN 削除、SELECT カラム限定）
- データ量削減（古いセッションのアーカイブ機能追加）

---

## 2. 信頼性（Reliability）

### 2.1 エラーハンドリング

**全 API 呼び出しは以下を満たすこと**:

- [ ] **Result<T, E> 型** を返却（成功/失敗を明示）
- [ ] **エラー時に適切なログ出力**（`logger.error` で原因・スタックトレース記録）
- [ ] **UI にユーザーフレンドリーなエラーメッセージ表示**（技術詳細はログのみ）
- [ ] **回復可能なエラーは再試行**（ネットワークエラー: 3回リトライ、指数バックオフ）
- [ ] **致命的エラーはクラッシュせず、部分機能停止**（AI API エラーでもアプリは動作継続）

**検証シナリオ**:
| エラー種別 | トリガー | 期待動作 |
|-----------|---------|----------|
| API キー無効 | 無効なキーで AI 呼び出し | トースト「API キーが無効です。設定を確認してください」 + ログ記録 |
| ネットワーク断 | オフライン時に AI 呼び出し | トースト「ネットワーク接続を確認してください」 + 3回リトライ |
| プロキシ認証失敗 | 誤った認証情報 | エラーメッセージ「プロキシ認証に失敗しました」 + 詳細ログ |
| DB 書き込み失敗 | ディスク容量不足 | トースト「データ保存に失敗しました」 + ログ記録 + 次回起動時に復旧試行 |
| MCP サーバークラッシュ | サーバー異常終了 | stderr ログ表示 + ステータス「Stopped」 + 再起動ボタン |

**不合格時の対処**:

- エラーハンドリングコードを追加（try-catch + Result 型）
- ユーザー向けメッセージを改善（専門用語排除、解決策提示）

---

### 2.2 データ整合性

- [ ] **トランザクション保証**: 複数テーブル更新は Drizzle トランザクションで原子性保証
- [ ] **外部キー制約**: `chat_messages.session_id` → `chat_sessions.id` で参照整合性
- [ ] **NULL 制約**: 必須カラム（`api_key`, `session_id`）は NOT NULL
- [ ] **バックアップ**: DB ファイル (`data.db`) は定期バックアップ（将来機能）

**検証方法**:

- Drizzle Schema で外部キー・NOT NULL 制約を確認
- 手動テスト: セッション削除時、関連メッセージも CASCADE 削除されること
- 自動テスト: トランザクション途中で例外発生 → ロールバック確認

---

### 2.3 耐障害性

| シナリオ                       | 期待動作                                                                    |
| ------------------------------ | --------------------------------------------------------------------------- |
| **Backend プロセスクラッシュ** | Main が検出 → 自動再起動 → Renderer に再接続通知                            |
| **AI ストリーミング中断**      | ユーザー停止 or タイムアウト → 部分応答を保存 → UI に「中断されました」表示 |
| **MCP サーバー応答なし**       | 30秒タイムアウト → エラー結果を AI に返却 → AI が代替案提示                 |
| **ディスク容量不足**           | DB 書き込み失敗 → エラー通知 → 古いセッション削除を提案                     |

**検証方法**:

- 手動テスト: Backend プロセスを強制終了 → 自動復旧確認
- 自動テスト: `AbortController` で中断シミュレーション

---

## 3. セキュリティ（Security）

### 3.1 認証情報の保護

- [ ] **API キー暗号化**: `settings` テーブルに保存する API キーは **暗号化**（`safeStorage` API 使用）
- [ ] **ログ出力制限**: API キー・パスワードはログに **出力禁止**（マスキング `***` で代替）
- [ ] **ファイルパーミッション**: DB ファイル (`data.db`) は **ユーザーのみ読み書き可能**（chmod 600 相当）

**検証方法**:

- コードレビュー: `logger.info` で API キーを出力していないか確認
- 手動テスト: `data.db` ファイルのパーミッション確認
- 自動テスト: 暗号化/復号化の正常動作確認

**不合格時の対処**:

- `safeStorage` API 統合（Electron の暗号化機能）
- ログ出力時に正規表現でマスキング処理追加

---

### 3.2 HITL（Human-in-the-Loop）

- [ ] **デフォルトは承認必須**: 初回ツール実行時は **必ず承認ダイアログ表示**
- [ ] **自動承認は明示的設定**: ユーザーが「今後このツールは自動承認」を選択した場合のみ
- [ ] **危険ツールの警告**: ファイル削除・外部API課金が発生するツールは **赤色警告表示**
- [ ] **監査ログ**: 全ツール実行（承認/拒否）を **ログ記録**（将来エクスポート可能）

**検証方法**:

- 手動テスト: 新規ツール実行時に承認ダイアログ表示確認
- 自動テスト: `ToolPermissionService` のルール評価ロジック検証

---

### 3.3 ネットワークセキュリティ

- [ ] **HTTPS 強制**: AI API 呼び出しは **HTTPS のみ**（HTTP は拒否）
- [ ] **証明書検証**: カスタム証明書使用時も **検証実施**（自己署名は明示的に許可）
- [ ] **プロキシ認証**: ユーザー名・パスワードは **暗号化保存**
- [ ] **タイムアウト**: 全ネットワーク呼び出しに **30秒タイムアウト** 設定

**検証方法**:

- コードレビュー: `fetch()` 呼び出しで HTTPS URL のみ許可
- 手動テスト: 自己署名証明書環境で接続テスト

---

## 4. ユーザビリティ（Usability）

### 4.1 エラーメッセージ

**全エラーメッセージは以下の形式に従うこと**:

```
[何が起きたか] + [なぜ起きたか（任意）] + [どうすればよいか]
```

**良い例**:

- ✅ 「API キーが無効です。設定画面で API キーを確認してください。」
- ✅ 「ネットワーク接続に失敗しました。プロキシ設定を確認するか、ネットワーク管理者にお問い合わせください。」
- ✅ 「MCP サーバーが起動できませんでした。コマンドが存在するか確認してください。」

**悪い例**:

- ❌ 「Error: ECONNREFUSED」（技術詳細のみ、解決策なし）
- ❌ 「失敗しました」（何が失敗したか不明）
- ❌ 「401 Unauthorized」（ユーザー向けでない）

**検証方法**:

- コードレビュー: 全エラーメッセージを確認
- 手動テスト: エラーシナリオを実行し、メッセージの明確さを評価

---

### 4.2 UI フィードバック

| アクション         | 期待フィードバック                                    |
| ------------------ | ----------------------------------------------------- |
| **ボタンクリック** | ボタンが押下状態になる（視覚的フィードバック）        |
| **API 呼び出し中** | ローディングスピナー or プログレスバー表示            |
| **操作成功**       | トースト通知（緑）「保存しました」                    |
| **操作失敗**       | トースト通知（赤）「保存に失敗しました」 + エラー詳細 |
| **長時間処理**     | 進捗表示（例: 「圧縮中... 45%」）                     |

**検証方法**:

- 手動テスト: 全インタラクションで適切なフィードバック表示確認
- アクセシビリティテスト: スクリーンリーダーで読み上げ確認

---

### 4.3 アクセシビリティ

- [ ] **キーボード操作**: 全機能をマウスなしで操作可能（Tab / Enter / Esc）
- [ ] **フォーカス表示**: フォーカス中の要素が明確に視認可能（アウトライン表示）
- [ ] **スクリーンリーダー対応**: 重要な要素に `aria-label` / `role` 属性
- [ ] **コントラスト比**: WCAG AA 基準（テキスト 4.5:1 以上）

**検証方法**:

- 手動テスト: キーボードのみでアプリ全体を操作
- 自動テスト: `axe-core` で WCAG 違反検出

---

## 5. 互換性（Compatibility）

### 5.1 プラットフォーム

| OS          | サポート範囲                      | 検証方法                         |
| ----------- | --------------------------------- | -------------------------------- |
| **Windows** | 10 / 11 (64bit)                   | 実機テスト + CI (GitHub Actions) |
| **macOS**   | 12 (Monterey) 以降                | 実機テスト + CI                  |
| **Linux**   | Ubuntu 20.04 以降（参考サポート） | CI のみ（実機テストなし）        |

**不合格時の対処**:

- プラットフォーム固有の不具合を修正
- サポート対象外の OS はドキュメントで明記

---

### 5.2 AI プロバイダー

| プロバイダー     | サポートモデル                   | 検証方法              |
| ---------------- | -------------------------------- | --------------------- |
| **OpenAI**       | GPT-4o, GPT-4, GPT-3.5-turbo     | 実 API 呼び出しテスト |
| **Anthropic**    | Claude 3.5 Sonnet, Claude 3 Opus | 実 API 呼び出しテスト |
| **Google**       | Gemini 1.5 Pro, Gemini 1.5 Flash | 実 API 呼び出しテスト |
| **Azure OpenAI** | GPT-4, GPT-35-turbo              | 手動テスト（Phase 2） |

**不合格時の対処**:

- プロバイダー固有のバグを修正
- サポート対象外のモデルはドキュメントで明記

---

### 5.3 ブラウザ / Electron バージョン

| 項目         | 基準                              |
| ------------ | --------------------------------- |
| **Electron** | 37.x 以降                         |
| **Chromium** | 130.x 以降（Electron に含まれる） |
| **Node.js**  | 20.x 以降（Electron に含まれる）  |

**検証方法**:

- `package.json` で Electron バージョン固定
- CI でバージョン互換性テスト

---

## 6. 運用（Operations）

### 6.1 ログ出力

**全ログは以下の形式に従うこと**:

```typescript
logger.info('[Context] Action', { key: value, ... })
logger.error('[Context] Error occurred', { error: err.message, stack: err.stack })
```

**ログレベル**:

- `info`: 正常動作ログ（AI 呼び出し開始/終了、セッション作成）
- `warn`: 警告（リトライ発生、非推奨 API 使用）
- `error`: エラー（API 失敗、DB エラー、クラッシュ）

**検証方法**:

- `app.log` ファイルを確認（タイムスタンプ・ログレベル・メッセージ形式）
- 自動テスト: ログ出力をモックして内容検証

---

### 6.2 アップデート

- [ ] **自動更新**: 起動時に新バージョン確認（3秒遅延）
- [ ] **手動確認**: 設定画面で「アップデートを確認」ボタン
- [ ] **署名検証**: ダウンロードファイルの署名を検証（electron-updater デフォルト）
- [ ] **ロールバック**: アップデート失敗時は旧バージョンで起動継続

**検証方法**:

- 手動テスト: GitHub Releases に新バージョンをアップロード → アプリで検出確認
- 自動テスト: モックサーバーで `latest.yml` を返却 → 更新通知確認

---

### 6.3 データ移行

**新バージョンで DB スキーマ変更時**:

- [ ] **マイグレーション自動実行**: 起動時に Drizzle が自動適用
- [ ] **バックアップ作成**: マイグレーション前に DB ファイルをコピー（`data.db.backup`）
- [ ] **ロールバック手順**: マイグレーション失敗時はバックアップから復元

**検証方法**:

- 手動テスト: 旧バージョン DB で新バージョンを起動 → マイグレーション成功確認
- 自動テスト: マイグレーションスクリプトを実行 → スキーマ検証

---

## 7. テスト戦略

### 7.1 自動テストカバレッジ

| 種別                 | 目標カバレッジ | 範囲                                              |
| -------------------- | -------------- | ------------------------------------------------- |
| **Unit Test**        | 80% 以上       | Backend ロジック（Service / Store / Compression） |
| **Integration Test** | 60% 以上       | IPC 通信、DB 操作                                 |
| **E2E Test**         | 主要フロー     | AI チャット、MCP ツール実行、圧縮（手動テスト）   |

**検証方法**:

- Vitest でカバレッジレポート生成（`--coverage`）
- CI で閾値チェック（カバレッジ低下時はビルド失敗）

---

### 7.2 CI/CD パイプライン

**全 PR は以下を通過すること**:

- [ ] Lint（ESLint）
- [ ] Type Check（TypeScript）
- [ ] Unit Test（Vitest）
- [ ] Build（electron-vite）
- [ ] E2E Test（主要フローのみ、手動 or Playwright）

**不合格時の対処**:

- CI エラーを修正してから merge

---

## まとめ

本受入基準は、**リリース判定の最低ライン**を示す。各基準を満たさない場合、該当機能はリリース対象外とする。

**優先順位**:

1. **性能・信頼性・セキュリティ**: MVP必須（P0）
2. **ユーザビリティ・アクセシビリティ**: 初期リリース推奨（P1）
3. **運用・互換性**: Phase 2以降（P2）

**次のステップ**:

- 本基準を基にテスト計画を作成
- QA チェックリスト化
- リリース前に全項目を検証
