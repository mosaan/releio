# MCPサーバー管理要件

## ドキュメント情報

- **作成日**: 2025-11-18
- **バージョン**: 2.0（UC-MCP-05追加）
- **対象ユースケース**: UC-MCP-01 〜 UC-MCP-05（5個のユースケース）
- **関連設計**: [MCP統合設計](./MCP_INTEGRATION_DESIGN.md)
- **注記**: UC-MCP-05はUC-CHAT-02の<<extend>>関係として、AI応答にツール呼び出しが含まれる場合に詳細を表示します。

## 1. UC-MCP-01: MCPサーバーを追加する

### 1.1 ユースケース概要

ユーザーが新しいMCPサーバー（ファイルシステム、GitHub、データベース等）を追加し、AIがそのツールにアクセスできるようにします。

### 1.2 事前条件

- The システム shall 設定画面が表示されている

### 1.3 事後条件

- The システム shall 新しいMCPサーバー設定がデータベースに保存されている
- If サーバーが有効状態で追加された, the システム shall サーバーが起動済みである

### 1.4 要件

#### 1.4.1 サーバー設定入力

**1. 必須フィールドの提供**

The システム shall 以下の必須フィールドを提供する：
- サーバー名（ユーザーが識別しやすい名前）
- 実行コマンド（例: "node"、"python"）
- コマンド引数（配列、例: ["/path/to/server.js"]）

**2. オプションフィールドの提供**

The システム shall 以下のオプションフィールドを提供する：
- 説明文
- 環境変数（キー・値のペア）
- 有効化フラグ（デフォルト: true）
- リソースをツールとして含めるフラグ（デフォルト: false）

**3. 引数の複数行入力**

The システム shall コマンド引数を1行につき1引数として入力できるテキストエリアを提供する

**4. 環境変数の表形式入力**

The システム shall 環境変数をキー・値のペアとして追加・削除できる表形式UIを提供する

#### 1.4.2 バリデーション

**5. 必須フィールドの検証**

If ユーザーが必須フィールド（サーバー名、コマンド、引数）を空欄のまま保存を試みた, the システム shall エラーメッセージを表示し保存を拒否する

**6. サーバー名の一意性検証**

If ユーザーが既存のサーバー名と重複する名前を入力した, the システム shall 警告メッセージを表示し、同名のサーバーが既に存在することを通知する

**7. コマンドパスの検証**

When ユーザーが実行コマンドを入力した, the システム shall コマンドが実行可能であることを検証する（パスの存在確認）

**8. 環境変数値の検証**

If ユーザーが環境変数に機密情報（APIキー等）を含めようとした, the システム shall 警告メッセージを表示し、平文で保存されることを通知する

#### 1.4.3 サーバー保存と起動

**9. UUID自動生成**

When ユーザーが新しいMCPサーバー設定を保存した, the システム shall ユニークなUUID識別子を自動生成し、設定に割り当てる

**10. タイムスタンプ自動記録**

When ユーザーが新しいMCPサーバー設定を保存した, the システム shall 作成日時（createdAt）と更新日時（updatedAt）を現在時刻で記録する

**11. 有効状態での自動起動**

When ユーザーが有効状態（enabled: true）でMCPサーバーを保存した, the システム shall 保存完了後に即座にサーバープロセスを起動する

**12. 無効状態での起動スキップ**

When ユーザーが無効状態（enabled: false）でMCPサーバーを保存した, the システム shall サーバープロセスを起動しない

#### 1.4.4 起動確認とエラーハンドリング

**13. 起動成功の通知**

When MCPサーバーが正常に起動した, the システム shall サーバー一覧で接続ステータスを"Connected"として表示する

**14. 起動失敗の通知**

If MCPサーバーの起動に失敗した, the システム shall エラーメッセージを表示し、サーバー一覧でステータスを"Error"として表示する

**15. エラー詳細の記録**

If MCPサーバーの起動に失敗した, the システム shall 標準エラー出力（stderr）と終了コードをログファイルに記録する

**16. 起動失敗時のバックエンド継続**

If MCPサーバーの起動に失敗した, the システム shall バックエンドプロセスを停止せず、他のサーバーと機能を継続する

---

## 2. UC-MCP-02: MCPサーバーを有効化/無効化する

### 2.1 ユースケース概要

ユーザーがMCPサーバーの起動状態を切り替えます。

### 2.2 事前条件

- The システム shall 少なくとも1つのMCPサーバー設定が存在する

### 2.3 事後条件

- If サーバーが有効化された, the システム shall サーバーが起動済みである
- If サーバーが無効化された, the システム shall サーバーが停止済みである

### 2.4 要件

#### 2.4.1 有効化/無効化操作

**17. 有効化トグルの提供**

The システム shall MCPサーバー一覧の各サーバーに有効化トグル（ON/OFF スイッチ）を提供する

**18. トグル状態の視覚的表示**

The システム shall 有効化トグルの状態（ON/OFF）を視覚的に明確に表示する

#### 2.4.2 有効化処理

**19. サーバーの即座起動**

When ユーザーが無効状態のサーバーを有効化した, the システム shall 即座にサーバープロセスを起動する

**20. 起動中の視覚的フィードバック**

While サーバーが起動処理中, the システム shall サーバー一覧にローディングインジケーターを表示する

**21. 起動成功時のステータス更新**

When サーバーが正常に起動した, the システム shall サーバー一覧のステータスを"Stopped"から"Connected"に更新する

**22. 起動失敗時のエラー表示**

If サーバーの起動に失敗した, the システム shall エラーメッセージを表示し、ステータスを"Error"に設定し、有効化トグルを自動的にOFFに戻す

#### 2.4.3 無効化処理

**23. サーバーの即座停止**

When ユーザーが有効状態のサーバーを無効化した, the システム shall 即座にサーバープロセスを停止する

**24. 停止中の視覚的フィードバック**

While サーバーが停止処理中, the システム shall サーバー一覧にローディングインジケーターを表示する

**25. 停止成功時のステータス更新**

When サーバーが正常に停止した, the システム shall サーバー一覧のステータスを"Connected"から"Stopped"に更新する

**26. 停止失敗時のエラー表示**

If サーバーの停止に失敗した, the システム shall エラーメッセージを表示し、強制終了を試みる

#### 2.4.4 ランタイム診断の表示

**27. 接続ステータスの表示**

The システム shall 各サーバーのランタイムステータス（Connected / Stopped / Error）をリアルタイムで表示する

**28. エラー詳細の表示**

When サーバーがエラー状態, the システム shall エラーメッセージと標準エラー出力（stderr）を展開可能な詳細パネルに表示する

**29. ステータス変化の通知**

When サーバーのステータスが変化した, the システム shall イベント通知（`mcpServerStatusChanged`）をレンダラープロセスに送信する

---

## 3. UC-MCP-03: MCPツール一覧を表示する

### 3.1 ユースケース概要

ユーザーが接続されたMCPサーバーが提供するツール一覧を確認します。

### 3.2 事前条件

- The システム shall 少なくとも1つのMCPサーバーが接続状態（Connected）である

### 3.3 事後条件

- The システム shall ツール一覧が設定画面に表示されている

### 3.4 要件

#### 3.4.1 ツール一覧の取得

**30. ツール一覧取得の提供**

The システム shall MCPサーバー設定画面に「ツール一覧を表示」オプションを提供する

**31. ツールリストのAPIリクエスト**

When ユーザーがツール一覧表示を要求した, the システム shall サーバーに対して`listTools()`リクエストを送信する

**32. 取得中の視覚的フィードバック**

While システムがツール一覧を取得している, the システム shall ローディングインジケーターを表示する

#### 3.4.2 ツール情報の表示

**33. ツール名の表示**

The システム shall 各ツールの名前（例: "read_file"、"github_search"）を一覧表示する

**34. ツール説明の表示**

The システム shall 各ツールの説明文（description）を表示する

**35. 入力スキーマの表示**

The システム shall 各ツールの入力スキーマ（JSON Schema形式）を展開可能な詳細パネルに表示する

**36. ツール数の表示**

The システム shall サーバーが提供するツールの総数を表示する

#### 3.4.3 ツールのフィルタと検索

**37. ツール検索の提供**

The システム shall ツール一覧に検索フィールドを提供する

**38. ツール名検索**

When ユーザーが検索フィールドにテキストを入力した, the システム shall ツール名または説明に検索テキストが含まれるツールのみを表示する

#### 3.4.4 エラーハンドリング

**39. サーバー未接続時のエラー**

If ユーザーが未接続のサーバーのツール一覧を表示しようとした, the システム shall エラーメッセージを表示し、サーバーを先に有効化するよう促す

**40. ツール取得失敗時のエラー**

If ツール一覧の取得中にエラーが発生した, the システム shall エラーメッセージを表示し、再試行オプションを提供する

---

## 4. UC-MCP-04: MCPリソース一覧を表示する

### 4.1 ユースケース概要

ユーザーが接続されたMCPサーバーが提供するリソース一覧を確認します。

### 4.2 事前条件

- The システム shall 少なくとも1つのMCPサーバーが接続状態（Connected）である

### 4.3 事後条件

- The システム shall リソース一覧が設定画面に表示されている

### 4.4 要件

#### 4.4.1 リソース一覧の取得

**41. リソース一覧取得の提供**

The システム shall MCPサーバー設定画面に「リソース一覧を表示」オプションを提供する

**42. リソースリストのAPIリクエスト**

When ユーザーがリソース一覧表示を要求した, the システム shall サーバーに対して`listResources()`リクエストを送信する

**43. 取得中の視覚的フィードバック**

While システムがリソース一覧を取得している, the システム shall ローディングインジケーターを表示する

#### 4.4.2 リソース情報の表示

**44. リソースURIの表示**

The システム shall 各リソースのURI（例: "file:///home/user/README.md"）を一覧表示する

**45. リソース名の表示**

The システム shall 各リソースの名前（name）を表示する

**46. リソース説明の表示**

The システム shall 各リソースの説明文（description）を表示する

**47. MIMEタイプの表示**

Where リソースにMIMEタイプ情報が含まれる, the システム shall MIMEタイプ（例: "text/markdown"）を表示する

**48. リソース数の表示**

The システム shall サーバーが提供するリソースの総数を表示する

#### 4.4.3 リソースのフィルタと検索

**49. リソース検索の提供**

The システム shall リソース一覧に検索フィールドを提供する

**50. リソースURI/名前検索**

When ユーザーが検索フィールドにテキストを入力した, the システム shall リソースURIまたは名前に検索テキストが含まれるリソースのみを表示する

**51. MIMEタイプフィルタ**

The システム shall リソース一覧にMIMEタイプによるフィルタオプション（テキスト、画像、その他）を提供する

#### 4.4.4 リソースをツールとして含める設定

**52. includeResourcesフラグの提供**

The システム shall MCPサーバー設定に「リソースをツールとして含める」チェックボックスを提供する

**53. includeResources警告の表示**

When ユーザーがincludeResourcesをONにしようとした, the システム shall コンテキストサイズが増加する可能性があることを警告メッセージで通知する

**54. リソースの限定的な使用推奨**

The システム shall includeResourcesフラグの説明に「リソース数が限定的なサーバーのみ推奨」と記載する

#### 4.4.5 エラーハンドリング

**55. サーバー未接続時のエラー**

If ユーザーが未接続のサーバーのリソース一覧を表示しようとした, the システム shall エラーメッセージを表示し、サーバーを先に有効化するよう促す

**56. リソース取得失敗時のエラー**

If リソース一覧の取得中にエラーが発生した, the システム shall エラーメッセージを表示し、再試行オプションを提供する

---

## 5. テスト可能性

### 5.1 受け入れテストシナリオ

**シナリオ1: MCPサーバーの追加と起動**
1. 設定画面で「MCPサーバーを追加」ボタンをクリック
2. サーバー名: "Filesystem Server"、コマンド: "npx"、引数: ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"]を入力
3. 有効化フラグをONに設定して保存
4. サーバーが起動し、ステータスが"Connected"になることを確認
5. ツール一覧を表示し、"read_file"、"write_file"等のツールが表示されることを確認

**シナリオ2: MCPサーバーの無効化と再有効化**
1. 接続中の"Filesystem Server"の有効化トグルをOFFにする
2. サーバーが停止し、ステータスが"Stopped"になることを確認
3. 有効化トグルをONに戻す
4. サーバーが再起動し、ステータスが"Connected"になることを確認
5. AIチャットでファイル読み取りツールが利用可能になることを確認

**シナリオ3: エラー状態のサーバー診断**
1. 無効なコマンド（存在しないパス）でMCPサーバーを追加
2. 有効化トグルをONにする
3. サーバー起動が失敗し、ステータスが"Error"になることを確認
4. エラー詳細パネルを展開し、stderrとエラーメッセージが表示されることを確認
5. コマンドパスを修正して保存
6. サーバーが正常に起動することを確認

### 5.2 検証基準

- サーバーのCRUD操作が全て正常に動作する
- サーバー起動失敗時もバックエンドプロセスが継続する
- ツール・リソース一覧が正確に取得・表示される
- エラー状態が明確に診断可能である
- ランタイムステータスがリアルタイムで更新される

---

## 6. 非機能要件

### 6.1 セキュリティ

**57. コマンド実行の制限**

The システム shall ユーザーが明示的に追加したMCPサーバーのみ実行を許可する

**58. 環境変数の保護**

The システム shall 環境変数（APIキー等）をuserDataディレクトリに平文で保存し、OSのファイルパーミッションで保護する

**59. 実行コマンドの表示**

The システム shall 各サーバーの実行コマンドと引数を設定画面に明示的に表示する

### 6.2 信頼性

**60. サーバークラッシュの分離**

If MCPサーバープロセスがクラッシュした, the システム shall 他のサーバーとバックエンドプロセスを継続する

**61. アプリ終了時のクリーンアップ**

When アプリケーションが終了する, the システム shall 全ての起動中MCPサーバーを停止し、リソースを解放する

### 6.3 ユーザビリティ

**62. サーバー設定のテンプレート**

The システム shall 一般的なMCPサーバー（filesystem、github等）の設定例をドキュメント化する（実装ではなく、ドキュメントでの提供）

**63. ログ出力の詳細化**

The システム shall MCPサーバーの起動、停止、ツール呼び出しをログファイルに詳細に記録する（[MCP]、[TOOLS]、[START]プレフィックス使用）

---

## 5. UC-MCP-05: ツール呼び出しを確認する

### 5.1 ユースケース概要

ユーザーがAIによるMCPツールの実行状況と結果を確認します。このユースケースはUC-CHAT-02（メッセージを送信する）の<<extend>>関係として、AI応答にツール呼び出しが含まれる場合に実行されます。

### 5.2 事前条件

- The システム shall 少なくとも1つのMCPサーバーが有効化されている
- The システム shall AIがツール呼び出しをサポートしている
- The システム shall AI応答にツール呼び出しが含まれている

### 5.3 事後条件

- The システム shall ツール呼び出しの詳細がチャット履歴に表示されている
- The システム shall ツール呼び出しがログファイルに記録されている

### 5.4 要件

#### 5.4.1 ツール呼び出しの表示

**64. ツールカードの表示**

When AIがMCPツールを呼び出した, the システム shall チャット履歴にツールカードを表示する

**65. ツール名の表示**

The システム shall ツールカードにツール名（例: "read_file"、"github_search"）を表示する

**66. 実行ステータスの表示**

The システム shall ツールカードに実行ステータス（実行中/完了/エラー）を表示する

**67. 実行中の視覚的フィードバック**

While ツールが実行中, the システム shall ツールカードにローディングインジケーターを表示する

#### 5.4.2 ツール詳細の表示

**68. 展開可能なツールカード**

The システム shall ツールカードをクリックで展開し、詳細情報を表示できるようにする

**69. 引数の表示**

When ツールカードが展開された, the システム shall ツールに渡された引数をJSON形式で表示する

**70. 結果の表示**

When ツールの実行が完了した, the システム shall ツールカードにツールの実行結果を表示する

**71. エラー詳細の表示**

If ツールの実行がエラーで終了した, the システム shall ツールカードにエラーメッセージとスタックトレース（利用可能な場合）を表示する

#### 5.4.3 マルチステップツール呼び出し

**72. ツールチェーンの表示**

When AIが複数のツールを連鎖的に呼び出した, the システム shall 各ツール呼び出しを時系列順にツールカードとして表示する

**73. ステップ数の制限**

The システム shall マルチステップツール呼び出しを最大10ステップまで許可する

**74. 無限ループ防止**

If AIが10ステップ以上のツール呼び出しを試みた, the システム shall ツール呼び出しを停止し、制限に達したことを示すメッセージを表示する

#### 5.4.4 ツールログの記録（内部処理）

**75. ツール呼び出しのログ記録**

When AIがMCPツールを呼び出した, the システム shall ツール名、引数、実行開始時刻をログファイルに記録する

**76. ツール結果のログ記録**

When ツールの実行が完了した, the システム shall ツール名、結果（最大200文字）、実行時間をログファイルに記録する

**77. ツールエラーのログ記録**

If ツールの実行がエラーで終了した, the システム shall ツール名、エラーメッセージ、スタックトレースをログファイルに記録する

---

## 6. 関連文書

- [要件定義概要](./REQUIREMENTS_OVERVIEW.md)
- [MCP統合設計](./MCP_INTEGRATION_DESIGN.md)
- [AI会話要件（ツール呼び出し）](./REQUIREMENTS_AI_CHAT.md)

---

**作成者メモ**: 本文書（v2.0）はUC-MCP-05を追加し、ツール呼び出しの確認機能を統合しました。全ての要件はEARSフォーマットに従い、テスト可能な要件として記述されています。MCPサーバーのライフサイクル管理とエラー診断を重視しています。
