# チャットセッション管理要件

## ドキュメント情報

- **作成日**: 2025-11-18
- **バージョン**: 1.0
- **対象ユースケース**: UC-SESS-01 〜 UC-SESS-04
- **関連設計**: [チャットセッション永続化](./CHAT_SESSION_PERSISTENCE.md), [会話履歴圧縮設計](./CONVERSATION_HISTORY_COMPRESSION_DESIGN.md)

## 1. UC-SESS-01: 新しいセッションを作成する

### 1.1 ユースケース概要

ユーザーが新しいチャット会話セッションを開始します。

### 1.2 事前条件

- The システム shall チャット画面が表示されている

### 1.3 事後条件

- The システム shall 新しいセッションがデータベースに作成されている
- The システム shall チャット履歴が空の状態でセッションが開始されている

### 1.4 要件

#### 1.4.1 セッション作成

**1. 新規セッションボタンの提供**

The システム shall チャット画面に「新しいセッション」ボタンを提供する

**2. セッションID自動生成**

When ユーザーが新規セッションを作成した, the システム shall ユニークなUUID識別子を自動生成し、セッションに割り当てる

**3. タイムスタンプ記録**

When ユーザーが新規セッションを作成した, the システム shall 作成日時（createdAt）と更新日時（updatedAt）を現在時刻で記録する

**4. デフォルトタイトル設定**

When ユーザーが新規セッションを作成した, the システム shall セッションタイトルをデフォルト値（"新しい会話"）に設定する

#### 1.4.2 セッション初期化

**5. メッセージ履歴のクリア**

When ユーザーが新規セッションを作成した, the システム shall チャット画面のメッセージ履歴をクリアする

**6. モデル選択の保持**

When ユーザーが新規セッションを作成した, the システム shall 現在選択中のモデルを新しいセッションでも保持する

**7. 即座の使用可能化**

When ユーザーが新規セッションを作成した, the システム shall 新しいセッションを即座に使用可能な状態にする

#### 1.4.3 未保存セッションの処理

**8. 未保存メッセージ警告**

If ユーザーが現在のセッションに未保存のメッセージがある状態で新規セッション作成を試みた, the システム shall 確認ダイアログを表示し、未保存の内容が失われることを警告する

**9. 自動保存の実行**

When ユーザーが新規セッション作成前の確認ダイアログで「保存して新規作成」を選択した, the システム shall 現在のセッションを保存してから新規セッションを作成する

---

## 2. UC-SESS-02: 過去のセッションを表示する

### 2.1 ユースケース概要

ユーザーが保存された過去のチャットセッションを一覧表示し、選択して再開します。

### 2.2 事前条件

- The システム shall 少なくとも1つの保存されたセッションが存在する

### 2.3 事後条件

- The システム shall 選択されたセッションのメッセージ履歴が表示されている

### 2.4 要件

#### 2.4.1 セッション一覧の表示

**10. セッション一覧パネルの提供**

The システム shall チャット画面にセッション一覧パネル（サイドバー）を提供する

**11. 新しいセッション順での表示**

The システム shall セッション一覧を更新日時（updatedAt）の降順で表示する

**12. セッションタイトルの表示**

The システム shall セッション一覧に各セッションのタイトルを表示する

**13. セッション日時の表示**

The システム shall セッション一覧に各セッションの更新日時を相対形式（"2時間前"、"昨日"等）で表示する

**14. メッセージプレビューの表示**

The システム shall セッション一覧に各セッションの最初のユーザーメッセージのプレビュー（最大50文字）を表示する

#### 2.4.2 セッションの読み込み

**15. セッション選択**

When ユーザーがセッション一覧からセッションをクリックした, the システム shall 選択されたセッションのメッセージ履歴をデータベースから読み込む

**16. メッセージ履歴の表示**

When セッションが読み込まれた, the システム shall 全てのメッセージ（ユーザーメッセージ、AIメッセージ、ツール呼び出し）を時系列順に表示する

**17. モデル選択の復元**

When セッションが読み込まれた, the システム shall セッション作成時に使用されたモデル選択を復元する

**18. スクロール位置の調整**

When セッションが読み込まれた, the システム shall チャット画面を最新メッセージまで自動スクロールする

#### 2.4.3 セッションの検索とフィルタ

**19. セッション検索の提供**

The システム shall セッション一覧に検索フィールドを提供する

**20. タイトル検索**

When ユーザーが検索フィールドにテキストを入力した, the システム shall セッションタイトルに検索テキストが含まれるセッションのみを表示する

**21. 日付フィルタ**

The システム shall セッション一覧に日付フィルタ（今日、昨日、先週、先月）を提供する

#### 2.4.4 読み込みエラーの処理

**22. セッション読み込みエラー**

If セッションの読み込み中にデータベースエラーが発生した, the システム shall エラーメッセージを表示し、セッション一覧に戻る

**23. 破損セッションの処理**

If セッションデータが破損している場合, the システム shall エラーメッセージを表示し、セッション一覧でそのセッションに警告アイコンを表示する

---

## 3. UC-SESS-03: セッションを削除する

### 3.1 ユースケース概要

ユーザーが不要なチャットセッションを削除します。

### 3.2 事前条件

- The システム shall 削除可能なセッションが存在する

### 3.3 事後条件

- The システム shall 指定されたセッションがデータベースから削除されている
- The システム shall セッション一覧から削除されたセッションが表示されていない

### 3.4 要件

#### 3.4.1 削除操作

**24. 削除オプションの提供**

The システム shall セッション一覧の各セッションに削除オプション（コンテキストメニューまたは削除ボタン）を提供する

**25. 削除確認ダイアログ**

When ユーザーがセッションの削除オプションを選択した, the システム shall 削除確認ダイアログを表示し、セッションタイトルを含む警告メッセージを表示する

**26. 確認後の削除実行**

When ユーザーが削除を確認した, the システム shall セッションと全ての関連メッセージをデータベースから削除する

#### 3.4.2 削除後の処理

**27. セッション一覧の更新**

When セッションが削除された, the システム shall セッション一覧から削除されたセッションを即座に非表示にする

**28. 現在セッションの削除時の処理**

When ユーザーが現在表示中のセッションを削除した, the システム shall 新しい空のセッションを自動作成し表示する

**29. 削除成功の通知**

When セッションが正常に削除された, the システム shall 一時的な成功メッセージ（トースト通知）を表示する

#### 3.4.3 一括削除

**30. 複数セッション選択**

The システム shall セッション一覧で複数のセッションを選択できるようにする

**31. 一括削除オプション**

Where 複数のセッションが選択されている, the システム shall 「選択したセッションを削除」オプションを提供する

**32. 一括削除確認**

When ユーザーが複数セッションの削除を試みた, the システム shall 削除されるセッション数を含む確認ダイアログを表示する

---

## 4. UC-SESS-04: セッション履歴を圧縮する

### 4.1 ユースケース概要

ユーザーが長い会話履歴をトークン制限内に収めるため、古いメッセージを要約・圧縮します。

### 4.2 事前条件

- The システム shall 現在のセッションのメッセージ履歴が存在する
- The システム shall メッセージ履歴の合計トークン数がモデルのコンテキスト制限に近づいている

### 4.3 事後条件

- The システム shall 圧縮されたメッセージ履歴がセッションデータとして保存されている
- The システム shall 圧縮により合計トークン数が削減されている

### 4.4 要件

#### 4.4.1 自動圧縮の検出

**33. トークン使用量の監視**

The システム shall 各メッセージ送信前に現在のセッションの合計トークン数を計算する

**34. 圧縮閾値の定義**

The システム shall モデルのコンテキスト制限の80%を圧縮開始の閾値として定義する

**35. 自動圧縮の通知**

When セッションの合計トークン数が圧縮閾値を超えた, the システム shall ユーザーに通知し、自動的に圧縮を実行するか確認する

#### 4.4.2 圧縮戦略

**36. 古いメッセージの要約**

When セッション履歴の圧縮が実行された, the システム shall 最も古いメッセージ群（最新の10メッセージを除く）をAIに要約させる

**37. システムメッセージへの変換**

When 古いメッセージが要約された, the システム shall 要約内容をシステムメッセージとして会話履歴の先頭に配置する

**38. 最新メッセージの保護**

While セッション履歴を圧縮している, the システム shall 最新の10メッセージを圧縮対象から除外し、元の形式で保持する

**39. ツール呼び出しの保護**

While セッション履歴を圧縮している, the システム shall 最新のツール呼び出しと結果を圧縮対象から除外する

#### 4.4.3 手動圧縮

**40. 手動圧縮オプションの提供**

The システム shall セッション設定メニューに「履歴を圧縮」オプションを提供する

**41. 圧縮前のプレビュー**

When ユーザーが手動圧縮オプションを選択した, the システム shall 圧縮前後のトークン数比較とメッセージ数の変化をプレビュー表示する

**42. 圧縮の実行確認**

When ユーザーが手動圧縮を実行しようとした, the システム shall 圧縮が不可逆操作であることを警告する確認ダイアログを表示する

#### 4.4.4 圧縮結果の記録

**43. 圧縮履歴の記録**

When セッション履歴が圧縮された, the システム shall 圧縮日時、圧縮前トークン数、圧縮後トークン数をログファイルに記録する

**44. 圧縮インジケーターの表示**

When セッションが圧縮済みの場合, the システム shall セッション一覧とチャット画面にバッジ（"圧縮済み"）を表示する

**45. 圧縮エラーの処理**

If 圧縮処理中にエラーが発生した, the システム shall 元のメッセージ履歴を保持し、エラーメッセージをユーザーに通知する

---

## 5. テスト可能性

### 5.1 受け入れテストシナリオ

**シナリオ1: セッションの作成と切り替え**
1. 「新しいセッション」ボタンをクリック
2. セッションAで"こんにちは"とメッセージを送信
3. 「新しいセッション」ボタンをクリックし、セッションBを作成
4. セッションBで"テストメッセージ"を送信
5. セッション一覧からセッションAを選択
6. セッションAのメッセージ履歴（"こんにちは"とAIの応答）が表示されることを確認

**シナリオ2: セッション削除**
1. セッション一覧に3つのセッションが存在する
2. セッション2の削除オプションを選択
3. 削除確認ダイアログで「削除」を選択
4. セッション一覧からセッション2が消えることを確認
5. データベースにセッション2が存在しないことを確認

**シナリオ3: 履歴圧縮**
1. 長いセッション（50メッセージ以上、トークン数が制限の85%）を作成
2. 新しいメッセージを送信しようとする
3. 圧縮通知が表示されることを確認
4. 「圧縮して続行」を選択
5. 古いメッセージが要約されてシステムメッセージに変換されることを確認
6. 最新10メッセージが元の形式で保持されることを確認
7. トークン数が削減されることを確認

### 5.2 検証基準

- セッションのCRUD操作が全て正常に動作する
- セッション一覧が常に最新状態を反映する
- 圧縮処理が失敗しても元のデータが保護される
- 削除操作が不可逆であることが明確に警告される
- トークン数計算が正確である

---

## 6. 非機能要件

### 6.1 パフォーマンス

**46. セッション一覧の高速表示**

The システム shall セッション一覧を500ms以内に表示する（最大1000セッションまで）

**47. セッション読み込みの低遅延**

The システム shall セッションのメッセージ履歴を1秒以内に表示する（最大500メッセージまで）

### 6.2 データ整合性

**48. セッションデータの原子性**

The システム shall セッション保存操作をアトミックに実行し、部分的な保存を防止する

**49. 同時編集の防止**

If ユーザーが複数のウィンドウで同じセッションを開いた, the システム shall 最初のウィンドウのみを編集可能にし、他のウィンドウを読み取り専用にする

### 6.3 ユーザビリティ

**50. セッションタイトルの編集**

The システム shall ユーザーがセッションタイトルを編集できるようにする

**51. セッションの自動保存**

The システム shall ユーザーがメッセージを送信するたびに自動的にセッションを保存する

---

## 7. 関連文書

- [要件定義概要](./REQUIREMENTS_OVERVIEW.md)
- [チャットセッション永続化設計](./CHAT_SESSION_PERSISTENCE.md)
- [会話履歴圧縮設計](./CONVERSATION_HISTORY_COMPRESSION_DESIGN.md)
- [会話履歴圧縮要件](./CONVERSATION_HISTORY_COMPRESSION_REQUIREMENTS.md)

---

**作成者メモ**: 本文書はEARSフォーマットに従い、テスト可能な要件として記述されています。セッション管理とトークン制限への対応を重視しています。
