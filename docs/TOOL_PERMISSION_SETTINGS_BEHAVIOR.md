# ツール実行許可設定の動作仕様

本ドキュメントでは、releioにおけるツール実行許可（HITL: Human-in-the-Loop）システムの動作仕様について解説します。

## 1. 概要

HITLシステムは、AIエージェントによるツールの実行に対して、ユーザーが事前に確認・承認を行うための仕組みです。セキュリティ上のリスクが高い操作（ファイルの削除、外部へのデータ送信など）を制限しつつ、信頼できる操作を自動承認することで、安全性と生産性のバランスを保つことを目的としています。

### システムの全体像

```text
+----------------+      1. ツール実行要求      +-------------------+
|                | --------------------------> |                   |
|  Mastra Agent  |                             | MastraToolService |
|                | <-------------------------- |                   |
+----------------+      4. 承認結果を返却      +---------+---------+
                                                         |
                                             2. 承認が必要か判定
                                                         |
                                             +-----------v-----------+
                                             | ToolPermissionService |
                                             +-----------+-----------+
                                                         |
                                             3. ルールに基づき判定
                                                         |
                                             +-----------v-----------+
                                             |    SQLite Database    |
                                             | (tool_permission_rules)|
                                             +-----------------------+
```

## 2. データモデル

実行許可ルールは以下の構造で管理されています。

### ToolPermissionRule (TypeScript)

```typescript
interface ToolPermissionRule {
  id: string
  serverId: string | null // MCPサーバーID (null = すべてのサーバー)
  toolName: string | null // 完全一致のツール名 (null = パターンまたはすべて)
  toolPattern: string | null // ワイルドカードパターン (例: "delete_*")
  autoApprove: boolean // true: 自動承認, false: 承認が必要
  priority: number // 優先度（数値が高いほど優先される）
  createdAt: string
  updatedAt: string
}
```

### データベーススキーマ (SQLite)

`tool_permission_rules` テーブルに保存されます。`auto_approve` は整数型（1=自動, 0=承認必要）として格納されます。

## 3. ルール判定ロジック

`ToolPermissionService.shouldAutoApprove` メソッドが判定を担います。

### 判定順序

1. データベースからすべてのルールを **優先度（priority）の降順** で取得します。
2. 各ルールを順に評価し、最初に条件に合致したルールの `autoApprove` 設定を適用します。
3. **どのルールにも合致しない場合、デフォルトで「承認が必要（false）」** と判定されます（安全側のデフォルト設定）。

### 条件合致の基準

1. **サーバーIDの不一致**: ルールに `serverId` が設定されている場合、実行対象ツールのサーバーIDと一致しなければスキップされます。
2. **ツール名の完全一致**: ルールに `toolName` が設定されている場合、ツール名が完全に一致すれば判定が確定します。
3. **パターンの合致**: ルールに `toolPattern` が設定されている場合、ワイルドカード（`*`）を用いたパターンマッチングを行います。
   - 例: `git_*` は `git_status`, `git_commit` などに合致。
4. **グローバルルール**: `serverId`, `toolName`, `toolPattern` がすべて `null` のルールは、すべてのツールに合致し、最終的なデフォルト設定として機能します。

### パターンマッチングの仕様

ワイルドカード `*` を使用でき、正規表現の `.*` に変換されて評価されます。大文字小文字は区別されません（Case-insensitive）。

## 4. 設定UIの動作

設定画面（`ToolPermissionSettings.tsx`）では、以下の操作が可能です。

- **ルールの表示**: 登録されているルールをリスト形式で表示します。サーバーID、ツール名、パターン、優先度、自動承認ステータスがバッジで可視化されます。
- **ルールの追加**:
  - サーバーID（任意）
  - 優先度（デフォルト 0）
  - ツール名（完全一致、任意）
  - ツールパターン（ワイルドカード、任意）
  - 自動承認の切り替えトグル
- **ルールの編集**: 既存のルールをインラインで編集できます。
- **ルールの削除**: 確認ダイアログを経てルールを削除できます。
- **即時反映**: ルールの作成・更新・削除を行うと、バックエンドでエージェントが再初期化され、新しい設定が即座に反映されます。

## 5. ツール実行承認ダイアログ

承認が必要と判定されたツールが実行される際、承認ダイアログ（`ToolApprovalDialog.tsx`）が表示されます。

### 表示内容

- **ツール名**: 実行しようとしているツールの名前。
- **サーバーID**: ツールを提供しているMCPサーバーの識別子。
- **入力パラメータ**: ツールに渡される引数が JSON 形式でフォーマットして表示されます。
- **警告メッセージ**: 信頼できない操作に対する注意喚起。

### ユーザー操作

- **承認 (Approve)**: ツールの実行を許可し、処理を続行します。
- **拒否 (Decline)**: ツールの実行を拒否し、エージェントにエラーとして通知します。

## 6. 現在の実装状況

現在のシステムは **Phase 3.2 (HITL 統合完了)** の段階にあります。

### 実装済み

- `ToolPermissionService` による CRUD 操作と判定ロジック
- 設定 UI によるルールの管理
- `MastraToolService` によるツールの `requireApproval` フラグの設定
- ルール変更時のエージェント再初期化
- **Mastra HITL 統合**: `tool-call-approval` イベントのハンドリング
- **承認フロー**: `approveToolCall` / `declineToolCall` による Mastra の suspend/resume 統合
- **承認ダイアログ**: `ToolApprovalDialog` による UI 表示とユーザー操作

### 動作フロー

1. ツール呼び出し時、`ToolPermissionService` がルールを評価
2. `requireApproval: true` のツールが呼ばれると、Mastra がストリームを一時停止
3. `tool-call-approval` イベントがフロントエンドに送信される
4. `ToolApprovalDialog` が表示され、ユーザーが承認/拒否を選択
5. `approveToolCall` / `declineToolCall` が呼ばれ、Mastra ストリームが再開

## 実用例（ルールの設定例）

| 優先度 | サーバーID       | ツール名          | パターン   | 自動承認 | 説明                                                     |
| :----- | :--------------- | :---------------- | :--------- | :------- | :------------------------------------------------------- |
| 100    | `filesystem`     | -                 | `read_*`   | ON       | ファイル読み込み系は常に許可                             |
| 100    | `filesystem`     | -                 | `delete_*` | OFF      | ファイル削除系は必ず承認を求める                         |
| 50     | `shell`          | `execute_command` | -          | OFF      | シェルコマンド実行は常に承認が必要                       |
| 10     | `weather-server` | -                 | -          | ON       | 天気サーバーのツールはすべて許可                         |
| 0      | -                | -                 | -          | OFF      | その他すべてのツールは承認が必要（グローバルデフォルト） |
