# 暗黙知の明示化

コードには現れない設計判断、ビジネスルール、歴史的経緯を収集・文書化する手順。

## なぜ暗黙知の抽出が必要か

コードから抽出できるのは「What（何をしているか）」だけ。
以下は抽出できない：

- **Why**: なぜその設計にしたのか
- **Why not**: なぜ他の選択肢を採用しなかったのか
- **Context**: 当時どんな制約があったのか
- **Intent**: 本来どうあるべきだったのか（技術的負債の背景）

これらは**人の記憶**や**過去の記録**からしか得られない。

---

## 1. ドメインエキスパートインタビュー

### インタビュー対象者

| 役割 | 期待できる情報 |
|------|----------------|
| **プロダクトオーナー/PM** | ビジネス要件、優先順位の理由 |
| **初期メンバー（開発者）** | 設計判断、技術選定の背景 |
| **運用担当者** | 実際の使われ方、問題点 |
| **ドメインエキスパート（業務担当）** | 業務フロー、例外ケース、用語の正確な意味 |

### インタビュー準備

```markdown
## インタビュー準備チェックリスト

### 事前準備
- [ ] 対象者を特定し、アポイントを取得
- [ ] 質問リストを作成（下記テンプレート参照）
- [ ] 現在のコード/ドキュメントを事前に確認
- [ ] 録音/録画の許可を得る（可能な場合）

### 持ち物
- [ ] 質問リスト（印刷またはデジタル）
- [ ] コード/設計図のプリントアウト（議論用）
- [ ] ホワイトボード/ノート
- [ ] 録音機材（許可がある場合）
```

### 質問テンプレート

#### 1. 用語・概念の確認

```markdown
## 用語確認インタビュー

### 基本質問
1. 「[用語]」という言葉の正確な意味を教えてください
2. この用語は社内で統一されていますか？別の呼び方をする人はいますか？
3. この概念はいつ、どのような状況で発生しますか？
4. この概念が存在しない/無効な状態はどういう場合ですか？

### 深掘り質問
5. [用語A]と[用語B]の違いは何ですか？
6. この概念に関する例外的なケースはありますか？
7. 過去にこの概念の定義が変わったことはありますか？
```

#### 2. 設計判断の背景

```markdown
## 設計判断インタビュー

### 対象機能: [機能名]

### 質問
1. この機能はなぜ必要になりましたか？
2. 当初の設計と現在の実装で違いはありますか？
3. 他の設計案は検討しましたか？採用しなかった理由は？
4. 当時どのような制約（時間、技術、人員）がありましたか？
5. 今振り返って、別の選択をしたいと思う点はありますか？
6. この設計で困っていること、技術的負債だと感じることは？
```

#### 3. ビジネスルールの確認

```markdown
## ビジネスルールインタビュー

### 対象: [業務プロセス名]

### 質問
1. このプロセスの開始条件は何ですか？
2. 正常に完了した状態とはどういう状態ですか？
3. エラー/例外が発生するのはどのような場合ですか？
4. そのエラー時、どう対処しますか？
5. このルールに例外はありますか？（特定顧客、特定期間など）
6. このルールは法律/規制に関係していますか？
7. 過去にこのルールが変更されたことはありますか？
```

### インタビュー結果の記録

```markdown
# インタビュー記録

## メタ情報
- **日時**: YYYY-MM-DD HH:MM
- **対象者**: [名前] ([役職])
- **インタビュアー**: [名前]
- **テーマ**: [トピック]

## サマリー
[3-5文で要約]

## 詳細メモ

### Q1: [質問]
> [回答の引用/要約]

**気づき**: [気づいたこと、追加質問の必要性など]

### Q2: [質問]
> [回答]

## 次のアクション
- [ ] [追加で確認すべきこと]
- [ ] [文書化すべきこと]

## 抽出されたアーティファクト候補
- **ADR候補**: [設計判断]
- **Glossary追加**: [新しい用語]
- **Invariant追加**: [新しい制約]
```

---

## 2. コードコメント・PR履歴からの情報抽出

### Git履歴の活用

#### コミットメッセージから設計判断を探す

```bash
# 特定ファイルの変更履歴
git log --oneline --follow -- src/domain/Order.ts

# "refactor" "fix" "change" を含むコミットを探す
git log --oneline --grep="refactor\|redesign\|fix" -- src/domain/

# 特定期間の変更を確認
git log --since="2023-01-01" --until="2023-06-30" -- src/domain/
```

#### コミットの詳細を確認

```bash
# コミットの詳細と差分
git show [commit-hash]

# なぜその変更が入ったか（関連するマージコミット）
git log --merges --ancestry-path [commit-hash]..HEAD
```

### PR/Issue履歴の活用

```bash
# GitHub CLIでPR一覧を取得
gh pr list --state merged --limit 100 --json number,title,body

# 特定のPRの詳細
gh pr view [PR番号] --comments

# Issue一覧（設計議論が含まれることが多い）
gh issue list --state closed --limit 100
```

### AI支援での情報抽出

```
コンテキスト:
- ファイル: [対象ファイルパス]
- 変更履歴:
[git logの結果を貼り付け]

- 関連PR:
[PRの説明文を貼り付け]

タスク:
上記の履歴から、このコードに関する設計判断や変更の背景を抽出してください。

要件:
1. 主要な設計変更を時系列で整理
2. 各変更の理由（Why）を特定
3. ADRとして記録すべき判断を提案
4. 技術的負債として認識されている点を特定

出力形式: Markdown（時系列リスト + ADR候補）
```

---

## 3. ADRの事後作成

インタビューや履歴分析から得た情報をADRとして記録する。

### 事後ADRテンプレート

```markdown
# ADR-[NNN]: [決定タイトル]（事後記録）

## ステータス
Accepted（事後記録: YYYY-MM-DD）

## 背景

### 当時の状況
[いつ頃、どのような状況で決定されたか]

### 解決すべき課題
[当時何が問題だったか]

### 制約条件
- [時間的制約]
- [技術的制約]
- [人員的制約]
- [ビジネス上の制約]

## 決定

[何を決定したか、どう実装したか]

## 決定の根拠

[なぜこの決定をしたのか。インタビューや履歴から得た情報]

### 情報源
- [インタビュー対象者]: [得られた情報]
- [PR/Issue番号]: [関連する記録]
- [コミット]: [関連する変更]

## 検討された代替案

### 代替案A: [名前]
- 概要: [説明]
- 不採用の理由: [理由]

### 代替案B: [名前]
- 概要: [説明]
- 不採用の理由: [理由]

## 結果

### 良かった点
- [メリット1]
- [メリット2]

### 問題点・技術的負債
- [問題1]
- [問題2]

### 今後の改善案
- [ ] [改善アクション]

## 関連
- 関連ADR: [ADR番号]
- 関連Issue: [Issue番号]
- 関連コード: [ファイルパス]
```

### 事後ADRの優先順位

以下の順で事後ADRを作成することを推奨：

1. **現在問題になっている設計判断** - 技術的負債の原因
2. **よく質問される「なぜ？」** - オンボーディングでよく聞かれること
3. **変更リスクが高い部分** - 触ると壊れそうな箇所
4. **外部連携に関わる判断** - 契約として機能しているもの

---

## 4. 技術的負債の文書化

### 技術的負債カタログ

```markdown
# 技術的負債カタログ

## TD-001: [負債タイトル]

### 概要
[何が問題か、1-2文で]

### 場所
- ファイル: [パス]
- 関連コンポーネント: [名前]

### 発生経緯
[なぜこうなったか。インタビューや履歴から]

### 影響
- **開発速度**: [影響の説明]
- **品質**: [影響の説明]
- **保守性**: [影響の説明]

### 理想的な状態
[本来どうあるべきか]

### 解消コスト
- 推定工数: [時間/日/週]
- 難易度: [低/中/高]
- リスク: [低/中/高]

### 解消計画
- [ ] [ステップ1]
- [ ] [ステップ2]

### 関連
- ADR: [事後ADR番号]
- Issue: [Tracking Issue番号]
```

### 負債の分類

| カテゴリ | 例 | 優先度判断基準 |
|----------|-----|----------------|
| **設計負債** | 不適切な責務分割、循環依存 | 変更頻度の高い箇所は優先 |
| **コード負債** | 重複コード、複雑な条件分岐 | バグ発生頻度で判断 |
| **テスト負債** | テストカバレッジ不足 | リスクの高い機能を優先 |
| **ドキュメント負債** | 古いドキュメント、未記載 | オンボーディング影響で判断 |
| **インフラ負債** | 古いライブラリ、EOL | セキュリティリスクで判断 |

---

## 5. 知識抽出のワークショップ

個別インタビューだけでなく、チームワークショップも有効。

### Event Storming（簡易版）

```markdown
## Event Stormingワークショップ

### 準備
- 参加者: ドメインエキスパート + 開発者（5-8人推奨）
- 時間: 2-3時間
- 用意: 付箋（オレンジ/青/黄/ピンク）、広い壁またはMiro

### 進め方

1. **イベント出し（30分）**
   - オレンジ付箋に「過去形の動詞」でイベントを書く
   - 例: 「注文が作成された」「支払いが完了した」
   - 時系列に並べる

2. **コマンド追加（20分）**
   - 青付箋に「イベントを起こすアクション」を書く
   - 例: 「注文を作成する」「支払いを処理する」

3. **アクター追加（15分）**
   - 黄付箋に「コマンドを実行する人/システム」を書く
   - 例: 「顧客」「決済システム」

4. **Aggregate識別（30分）**
   - 関連するイベント/コマンドをグルーピング
   - ピンク付箋で「Aggregate名」をつける

5. **問題点の議論（30分）**
   - 「ここがわかりにくい」「ここで問題が起きる」を共有
   - 赤付箋でマーク

### アウトプット
- Context Mapのドラフト
- Domain Eventsの一覧
- 議論すべき問題点リスト
```

### 用語統一ワークショップ

```markdown
## 用語統一ワークショップ

### 準備
- 参加者: ビジネス側 + 開発側
- 時間: 1-2時間
- 用意: 現在のGlossary（抽出済みのもの）

### 進め方

1. **用語レビュー（40分）**
   - 抽出した用語を1つずつ確認
   - 「この定義で合っているか？」
   - 「別の呼び方をする人はいるか？」

2. **不足用語の追加（20分）**
   - 「よく使うけどリストにない言葉は？」
   - ビジネス側から追加提案を受ける

3. **同義語の整理（20分）**
   - 同じ概念の別名を洗い出す
   - どれを「正式名称」にするか決定

4. **合意形成（10分）**
   - 更新したGlossaryを全員で確認
   - 「今後はこの用語で統一」を合意

### アウトプット
- 合意されたGlossary
- 同義語マッピング表
```

---

## 収集した知識の保管場所

```
project-repo/
├── adr/
│   ├── ADR-001-original-decision.md     # 通常のADR
│   ├── ADR-002-retrospective.md         # 事後ADR
│   └── ...
├── docs/
│   ├── interviews/
│   │   ├── 2024-01-15-john-pm.md        # インタビュー記録
│   │   └── 2024-01-20-jane-dev.md
│   ├── tech-debt/
│   │   └── catalog.md                   # 技術的負債カタログ
│   └── workshops/
│       └── 2024-02-event-storming.md    # ワークショップ記録
└── domain/
    └── glossary.yaml                     # 更新されたGlossary
```

---

## 次のステップ

- 抽出した知識を構造化したい → [reverse-engineering.md](reverse-engineering.md)
- 導入計画を立てたい → [migration-roadmap.md](migration-roadmap.md)
- ギャップ診断に戻る → [gap-analysis.md](gap-analysis.md)
